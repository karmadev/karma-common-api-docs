<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Karma — Beta Environment Architecture</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500&display=swap');

  :root {
    --bg: #1a1a2e;
    --bg-raised: #16213e;
    --bg-card: #1c2842;
    --border: #0f3460;
    --border-hover: #1a4a7a;
    --text: #e8e8f0;
    --text-muted: #a0a0b8;
    --text-dim: #5a5a78;

    --accent-blue: #5b9cf5;
    --accent-cyan: #e94560;
    --accent-purple: #a78bfa;
    --accent-pink: #f472b6;
    --accent-orange: #fb923c;
    --accent-green: #34d399;
    --accent-red: #e94560;
    --accent-yellow: #fbbf24;

    --layer-frontend: #5b9cf5;
    --layer-gateway: #a78bfa;
    --layer-backend: #e94560;
    --layer-functions: #fb923c;
    --layer-data: #f472b6;
    --layer-external: #fbbf24;
    --layer-cicd: #34d399;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    overflow-x: hidden;
    min-height: 100vh;
  }

  /* Grain overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    z-index: 9999;
    pointer-events: none;
    opacity: 0.015;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
    background-repeat: repeat;
    background-size: 256px;
  }

  /* Header */
  .header {
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(20px) saturate(1.2);
    -webkit-backdrop-filter: blur(20px) saturate(1.2);
    background: rgba(26, 26, 46, 0.9);
    border-bottom: 1px solid var(--border);
    padding: 0 40px;
  }

  .header-inner {
    max-width: 1600px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 64px;
  }

  .logo-area {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .logo-mark {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 700;
    font-size: 14px;
    color: var(--bg);
  }

  .logo-text {
    font-weight: 600;
    font-size: 15px;
    letter-spacing: -0.02em;
  }

  .logo-text span {
    color: var(--text-muted);
    font-weight: 400;
    margin-left: 4px;
  }

  .header-meta {
    display: flex;
    align-items: center;
    gap: 20px;
    font-size: 12px;
    font-family: 'JetBrains Mono', monospace;
    color: var(--text-muted);
  }

  .env-badge {
    padding: 4px 12px;
    border-radius: 20px;
    background: rgba(233, 69, 96, 0.1);
    border: 1px solid rgba(233, 69, 96, 0.2);
    color: var(--accent-cyan);
    font-weight: 500;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .project-id {
    opacity: 0.5;
  }

  /* Controls */
  .controls {
    position: sticky;
    top: 0;
    z-index: 90;
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    background: rgba(26, 26, 46, 0.8);
    border-bottom: 1px solid var(--border);
    padding: 12px 0;
  }

  .controls-inner {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0 40px;
  }

  .filter-btn {
    padding: 6px 14px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-muted);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .filter-btn:hover {
    border-color: var(--border-hover);
    color: var(--text);
    background: var(--bg-raised);
  }

  .filter-btn.active {
    border-color: var(--accent-cyan);
    color: var(--accent-cyan);
    background: rgba(233, 69, 96, 0.06);
  }

  .filter-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .controls-sep {
    width: 1px;
    height: 20px;
    background: var(--border);
    margin: 0 4px;
  }

  .search-box {
    margin-left: auto;
    padding: 6px 12px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    width: 200px;
    outline: none;
    transition: border-color 0.2s;
  }

  .search-box::placeholder { color: var(--text-dim); }
  .search-box:focus { border-color: var(--accent-cyan); }

  /* Main content */
  .main {
    max-width: 1600px;
    margin: 0 auto;
    padding: 40px 40px 80px;
  }

  /* Layer sections */
  .layer {
    margin-bottom: 32px;
    animation: layerIn 0.6s ease-out both;
  }

  .layer:nth-child(1) { animation-delay: 0.05s; }
  .layer:nth-child(2) { animation-delay: 0.1s; }
  .layer:nth-child(3) { animation-delay: 0.15s; }
  .layer:nth-child(4) { animation-delay: 0.2s; }
  .layer:nth-child(5) { animation-delay: 0.25s; }
  .layer:nth-child(6) { animation-delay: 0.3s; }
  .layer:nth-child(7) { animation-delay: 0.35s; }

  @keyframes layerIn {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .layer-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    padding-left: 2px;
  }

  .layer-indicator {
    width: 3px;
    height: 20px;
    border-radius: 2px;
  }

  .layer-title {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .layer-count {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--text-dim);
    padding: 2px 8px;
    border-radius: 4px;
    background: var(--bg-raised);
    border: 1px solid var(--border);
  }

  .layer-desc {
    font-size: 12px;
    color: var(--text-muted);
    margin-left: auto;
    font-style: italic;
  }

  /* Service grid */
  .services-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 10px;
  }

  .services-grid.compact {
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  }

  /* Connection flow indicator between layers */
  .flow-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 24px;
    margin-bottom: 32px;
    position: relative;
  }

  .flow-line {
    position: absolute;
    left: 50%;
    top: 0;
    bottom: 0;
    width: 1px;
    background: linear-gradient(to bottom, var(--border), transparent);
  }

  .flow-arrow {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    z-index: 1;
  }

  .flow-arrow svg {
    width: 10px;
    height: 10px;
    color: var(--text-dim);
  }

  /* Service card */
  .service-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
    cursor: default;
    transition: all 0.25s ease;
    position: relative;
    overflow: hidden;
  }

  .service-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    opacity: 0;
    transition: opacity 0.25s;
  }

  .service-card:hover {
    border-color: var(--border-hover);
    transform: translateY(-1px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.3);
  }

  .service-card:hover::before {
    opacity: 1;
  }

  .service-card.highlight {
    border-color: var(--accent-cyan) !important;
    box-shadow: 0 0 20px rgba(233, 69, 96, 0.08);
  }

  .service-card.dimmed {
    opacity: 0.25;
    transform: scale(0.98);
  }

  .card-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .card-name {
    font-size: 13px;
    font-weight: 600;
    letter-spacing: -0.01em;
    line-height: 1.3;
  }

  .card-icon {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    font-weight: 600;
  }

  .card-tech {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--text-muted);
    margin-bottom: 10px;
  }

  .card-desc {
    font-size: 11.5px;
    color: var(--text-muted);
    line-height: 1.5;
    margin-bottom: 10px;
  }

  .card-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }

  .card-tag {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    padding: 2px 7px;
    border-radius: 3px;
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--border);
    color: var(--text-dim);
    white-space: nowrap;
  }

  .card-tag.conn {
    border-color: rgba(233, 69, 96, 0.15);
    color: rgba(233, 69, 96, 0.6);
  }

  .card-port {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--text-dim);
    position: absolute;
    top: 16px;
    right: 16px;
  }

  .card-url {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--accent-cyan);
    opacity: 0.6;
    margin-top: 8px;
    word-break: break-all;
  }

  /* Color variants */
  .service-card[data-layer="frontend"]::before { background: linear-gradient(90deg, var(--layer-frontend), transparent); }
  .service-card[data-layer="frontend"] .card-icon { background: rgba(79, 140, 255, 0.1); color: var(--layer-frontend); }

  .service-card[data-layer="gateway"]::before { background: linear-gradient(90deg, var(--layer-gateway), transparent); }
  .service-card[data-layer="gateway"] .card-icon { background: rgba(167, 139, 250, 0.1); color: var(--layer-gateway); }

  .service-card[data-layer="backend"]::before { background: linear-gradient(90deg, var(--layer-backend), transparent); }
  .service-card[data-layer="backend"] .card-icon { background: rgba(233, 69, 96, 0.1); color: var(--layer-backend); }

  .service-card[data-layer="functions"]::before { background: linear-gradient(90deg, var(--layer-functions), transparent); }
  .service-card[data-layer="functions"] .card-icon { background: rgba(251, 146, 60, 0.1); color: var(--layer-functions); }

  .service-card[data-layer="data"]::before { background: linear-gradient(90deg, var(--layer-data), transparent); }
  .service-card[data-layer="data"] .card-icon { background: rgba(244, 114, 182, 0.1); color: var(--layer-data); }

  .service-card[data-layer="external"]::before { background: linear-gradient(90deg, var(--layer-external), transparent); }
  .service-card[data-layer="external"] .card-icon { background: rgba(251, 191, 36, 0.1); color: var(--layer-yellow); }

  .service-card[data-layer="cicd"]::before { background: linear-gradient(90deg, var(--layer-cicd), transparent); }
  .service-card[data-layer="cicd"] .card-icon { background: rgba(52, 211, 153, 0.1); color: var(--layer-cicd); }

  /* Functions group card */
  .func-group {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
    transition: all 0.25s;
  }

  .func-group:hover {
    border-color: var(--border-hover);
  }

  .func-group.dimmed {
    opacity: 0.25;
  }

  .func-group-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
  }

  .func-group-icon {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(251, 146, 60, 0.1);
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    font-weight: 600;
    color: var(--layer-functions);
  }

  .func-group-title {
    font-size: 13px;
    font-weight: 600;
  }

  .func-group-count {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--text-dim);
    margin-left: auto;
  }

  .func-list {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }

  .func-item {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 4px;
    background: rgba(251, 146, 60, 0.04);
    border: 1px solid rgba(251, 146, 60, 0.1);
    color: rgba(251, 146, 60, 0.7);
    transition: all 0.2s;
  }

  .func-item:hover {
    background: rgba(251, 146, 60, 0.08);
    border-color: rgba(251, 146, 60, 0.2);
    color: var(--layer-functions);
  }

  .func-item.dimmed {
    opacity: 0.25;
  }

  .func-trigger {
    font-size: 8px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.5;
    margin-left: 2px;
  }

  /* Networking section */
  .network-bar {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 20px 24px;
    display: flex;
    align-items: center;
    gap: 32px;
    flex-wrap: wrap;
    margin-bottom: 32px;
    position: relative;
    overflow: hidden;
  }

  .network-bar::before {
    content: '';
    position: absolute;
    inset: 0;
    background: repeating-linear-gradient(
      90deg,
      transparent,
      transparent 40px,
      rgba(255,255,255,0.008) 40px,
      rgba(255,255,255,0.008) 41px
    );
    pointer-events: none;
  }

  .net-item {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .net-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    position: relative;
  }

  .net-dot::after {
    content: '';
    position: absolute;
    inset: -3px;
    border-radius: 50%;
    border: 1px solid currentColor;
    opacity: 0.2;
  }

  .net-label {
    font-size: 11px;
    color: var(--text-muted);
  }

  .net-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--text);
  }

  .net-sep {
    width: 1px;
    height: 24px;
    background: var(--border);
  }

  /* Stats footer */
  .stats-bar {
    display: flex;
    gap: 24px;
    padding: 24px 0;
    border-top: 1px solid var(--border);
    margin-top: 24px;
    flex-wrap: wrap;
  }

  .stat {
    text-align: center;
  }

  .stat-val {
    font-family: 'JetBrains Mono', monospace;
    font-size: 24px;
    font-weight: 300;
    color: var(--text);
    line-height: 1;
    margin-bottom: 4px;
  }

  .stat-label {
    font-size: 10px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  /* Functions grid layout */
  .func-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 10px;
  }

  /* Tooltip */
  .tooltip {
    position: fixed;
    z-index: 1000;
    background: var(--bg-card);
    border: 1px solid var(--border-hover);
    border-radius: 8px;
    padding: 12px 16px;
    max-width: 300px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s;
    box-shadow: 0 12px 40px rgba(0,0,0,0.5);
    font-size: 12px;
    line-height: 1.5;
    color: var(--text-muted);
  }

  .tooltip.visible { opacity: 1; }

  .tooltip strong { color: var(--text); font-weight: 600; }

  /* Responsive */
  @media (max-width: 768px) {
    .header { padding: 0 20px; }
    .controls { padding: 12px 20px; }
    .main { padding: 24px 20px 60px; }
    .services-grid { grid-template-columns: 1fr; }
    .func-grid { grid-template-columns: 1fr; }
    .header-meta { display: none; }
    .layer-desc { display: none; }
    .network-bar { flex-direction: column; gap: 12px; align-items: flex-start; }
    .net-sep { width: 100%; height: 1px; }
  }

  /* ===================== */
  /* GRAPH VIEW STYLES    */
  /* ===================== */

  .view-toggle {
    display: flex;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 7px;
    overflow: hidden;
    width: 100%;
  }

  .view-btn {
    padding: 8px 14px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    white-space: nowrap;
    flex: 1;
  }

  .view-btn:hover { color: var(--text); }
  .view-btn.active {
    background: rgba(233, 69, 96, 0.1);
    color: var(--accent-cyan);
  }

  .view-btn svg { width: 13px; height: 13px; }

  .graph-container {
    display: none;
    position: fixed;
    top: 49px;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg);
    z-index: 50;
    overflow: hidden;
  }

  .graph-container.active { display: block; }

  .graph-container svg {
    width: 100%;
    height: 100%;
    cursor: grab;
  }
  .graph-container svg.dragging-node { cursor: grabbing; }
  .graph-container svg.panning { cursor: grabbing; }

  /* Graph edges */
  .graph-edge {
    fill: none;
    stroke-width: 1.2;
    opacity: 0.35;
    transition: opacity 0.3s, stroke-width 0.3s;
  }
  .graph-edge.type-api { stroke: var(--accent-cyan); stroke-dasharray: none; }
  .graph-edge.type-event { stroke: var(--accent-orange); stroke-dasharray: 6 4; }
  .graph-edge.type-monitor { stroke: var(--accent-yellow); stroke-dasharray: 2 3; }

  .graph-edge.highlighted {
    opacity: 0.85;
    stroke-width: 2;
  }
  .graph-edge.dimmed { opacity: 0.06; }

  /* Animated flow on edges */
  @keyframes dashFlow {
    to { stroke-dashoffset: -20; }
  }
  .graph-edge.highlighted.type-api { animation: dashFlow 1.5s linear infinite; stroke-dasharray: 8 4; }
  .graph-edge.highlighted.type-event { animation: dashFlow 1s linear infinite; }

  /* Edge hover label */
  .edge-label-bg {
    fill: var(--bg-card);
    rx: 4;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .edge-label-text {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    fill: var(--text-muted);
    text-anchor: middle;
    dominant-baseline: central;
    opacity: 0;
    transition: opacity 0.2s;
    pointer-events: none;
  }

  /* Graph nodes */
  .graph-node { cursor: grab; }
  .graph-node:active { cursor: grabbing; }
  .graph-node.dimmed { opacity: 0.12; }

  .node-body {
    transition: filter 0.25s, transform 0.25s;
    transform-origin: center;
  }

  .graph-node:hover .node-body,
  .graph-node.highlighted .node-body {
    filter: drop-shadow(0 0 12px rgba(233, 69, 96, 0.2));
  }

  .node-rect {
    rx: 8;
    stroke-width: 1.2;
    transition: stroke-width 0.2s, stroke 0.2s;
  }

  .graph-node:hover .node-rect,
  .graph-node.highlighted .node-rect {
    stroke-width: 2;
  }

  .node-label {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 11px;
    font-weight: 600;
    fill: var(--text);
    text-anchor: middle;
    dominant-baseline: central;
    pointer-events: none;
  }

  .node-sublabel {
    font-family: 'JetBrains Mono', monospace;
    font-size: 8.5px;
    fill: var(--text-muted);
    text-anchor: middle;
    dominant-baseline: central;
    pointer-events: none;
  }

  .node-dot {
    r: 3;
    transition: r 0.2s;
  }
  .graph-node:hover .node-dot { r: 4; }

  /* Detail panel */
  .graph-detail {
    position: fixed;
    top: 61px;
    right: 16px;
    width: 280px;
    max-height: calc(100vh - 160px);
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    z-index: 60;
    overflow-y: auto;
    box-shadow: 0 16px 48px rgba(0,0,0,0.5);
    opacity: 0;
    transform: translateX(12px);
    transition: opacity 0.25s, transform 0.25s;
    pointer-events: none;
  }

  .graph-detail.visible {
    opacity: 1;
    transform: translateX(0);
    pointer-events: auto;
  }

  .detail-close {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 24px;
    height: 24px;
    border: none;
    background: rgba(255,255,255,0.05);
    border-radius: 6px;
    color: var(--text-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: background 0.2s;
  }
  .detail-close:hover { background: rgba(255,255,255,0.1); color: var(--text); }

  .detail-name {
    font-size: 15px;
    font-weight: 700;
    margin-bottom: 2px;
    padding-right: 28px;
  }

  .detail-tech {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--text-muted);
    margin-bottom: 12px;
  }

  .detail-layer-badge {
    display: inline-block;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    padding: 3px 10px;
    border-radius: 4px;
    margin-bottom: 16px;
  }

  .detail-section-title {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-dim);
    margin-bottom: 8px;
    margin-top: 4px;
  }

  .detail-conn-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 5px;
    margin-bottom: 14px;
  }

  .detail-conn-item {
    font-size: 11.5px;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 0;
  }

  .detail-conn-arrow {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    flex-shrink: 0;
    width: 16px;
    text-align: center;
  }

  .detail-conn-type {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    padding: 1px 5px;
    border-radius: 3px;
    flex-shrink: 0;
  }
  .detail-conn-type.api { background: rgba(233,69,96,0.1); color: var(--accent-cyan); }
  .detail-conn-type.event { background: rgba(251,146,60,0.1); color: var(--accent-orange); }
  .detail-conn-type.monitor { background: rgba(251,191,36,0.1); color: var(--accent-yellow); }

  /* Graph legend */
  .graph-legend {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 18px;
    z-index: 60;
    display: none;
    gap: 14px;
    font-size: 11px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  }

  .graph-legend.visible { display: flex; flex-wrap: wrap; }

  .legend-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .legend-title {
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-dim);
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-muted);
    font-size: 10.5px;
  }

  .legend-line {
    width: 24px;
    height: 2px;
    flex-shrink: 0;
  }
  .legend-line.solid { background: var(--accent-cyan); }
  .legend-line.dashed { background: repeating-linear-gradient(90deg, var(--accent-orange) 0, var(--accent-orange) 5px, transparent 5px, transparent 8px); }
  .legend-line.dotted { background: repeating-linear-gradient(90deg, var(--accent-yellow) 0, var(--accent-yellow) 2px, transparent 2px, transparent 5px); }

  .legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  /* Graph zoom controls */
  .graph-zoom-controls {
    position: fixed;
    bottom: 20px;
    right: 20px;
    display: none;
    flex-direction: column;
    gap: 4px;
    z-index: 60;
  }
  .graph-zoom-controls.visible { display: flex; }

  .zoom-btn {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--bg-card);
    color: var(--text-muted);
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    font-family: 'JetBrains Mono', monospace;
  }
  .zoom-btn:hover { border-color: var(--border-hover); color: var(--text); background: var(--bg-raised); }

  /* ===================== */
  /* INFO VIEW STYLES     */
  /* ===================== */

  .info-container {
    display: none;
    max-width: 1600px;
    margin: 0 auto;
    padding: 40px 40px 80px;
  }

  .info-container.active { display: block; }

  .info-hero {
    margin-bottom: 48px;
    padding-bottom: 32px;
    border-bottom: 1px solid var(--border);
  }

  .info-hero h1 {
    font-size: 28px;
    font-weight: 700;
    letter-spacing: -0.03em;
    margin-bottom: 12px;
    background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .info-hero p {
    font-size: 15px;
    color: var(--text-muted);
    line-height: 1.7;
    max-width: 800px;
  }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(460px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
  }

  .info-section {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 28px;
    transition: border-color 0.2s;
  }

  .info-section:hover {
    border-color: var(--border-hover);
  }

  .info-section-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 16px;
    font-size: 16px;
  }

  .info-section h2 {
    font-size: 15px;
    font-weight: 700;
    margin-bottom: 12px;
    letter-spacing: -0.01em;
  }

  .info-section p {
    font-size: 13px;
    color: var(--text-muted);
    line-height: 1.7;
    margin-bottom: 12px;
  }

  .info-section p:last-child { margin-bottom: 0; }

  .info-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .info-list li {
    font-size: 13px;
    color: var(--text-muted);
    line-height: 1.6;
    padding-left: 20px;
    position: relative;
  }

  .info-list li::before {
    content: '';
    position: absolute;
    left: 0;
    top: 8px;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--accent-cyan);
    opacity: 0.5;
  }

  .info-list li strong {
    color: var(--text);
    font-weight: 600;
  }

  .info-tag {
    display: inline-block;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 4px;
    background: rgba(233, 69, 96, 0.06);
    border: 1px solid rgba(233, 69, 96, 0.15);
    color: var(--accent-cyan);
    margin-right: 4px;
    margin-bottom: 4px;
  }

  .info-callout {
    background: rgba(233, 69, 96, 0.04);
    border: 1px solid rgba(233, 69, 96, 0.12);
    border-radius: 10px;
    padding: 20px 24px;
    margin-top: 20px;
  }

  .info-callout p {
    font-size: 13px;
    color: var(--text-muted);
    line-height: 1.7;
  }

  .info-callout strong {
    color: var(--accent-cyan);
  }

  /* Flow diagram */
  .flow-diagram {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 32px 24px;
    overflow-x: auto;
  }

  .flow-diagram svg {
    display: block;
    margin: 0 auto;
  }

  .flow-step-rect {
    rx: 8;
    transition: filter 0.2s;
  }

  .flow-step:hover .flow-step-rect {
    filter: brightness(1.2);
  }

  .flow-step-label {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 11px;
    font-weight: 600;
    fill: var(--text);
    text-anchor: middle;
    dominant-baseline: central;
    pointer-events: none;
  }

  .flow-step-sub {
    font-family: 'JetBrains Mono', monospace;
    font-size: 8.5px;
    fill: var(--text-muted);
    text-anchor: middle;
    dominant-baseline: central;
    pointer-events: none;
  }

  .flow-arrow-line {
    stroke: var(--border-hover);
    stroke-width: 1.5;
    fill: none;
    marker-end: url(#flowArrow);
  }

  .flow-arrow-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 7.5px;
    fill: var(--text-dim);
    text-anchor: middle;
    dominant-baseline: central;
  }

  .flow-branch-line {
    stroke: var(--border-hover);
    stroke-width: 1;
    stroke-dasharray: 4 3;
    fill: none;
    marker-end: url(#flowArrow);
  }

  .flow-phase-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 8px;
    fill: var(--text-dim);
    text-anchor: middle;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  @media (max-width: 768px) {
    .info-grid { grid-template-columns: 1fr; }
    .info-container { padding: 24px 20px 60px; }
  }

  /* Print styles */
  @media print {
    body { background: #fff; color: #111; }
    .header, .controls { position: static; background: #fff; }
    .service-card { break-inside: avoid; border-color: #ddd; background: #fafafa; }
    body::before { display: none; }
  }
</style>
</head>
<body>

<div class="controls">
  <div class="controls-inner">
    <div class="view-toggle">
      <button class="view-btn active" data-view="grid">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
        Grid
      </button>
      <button class="view-btn" data-view="graph">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="5" cy="6" r="3"/><circle cx="19" cy="6" r="3"/><circle cx="12" cy="18" r="3"/><line x1="7.5" y1="7.5" x2="10" y2="16"/><line x1="16.5" y1="7.5" x2="14" y2="16"/><line x1="8" y1="6" x2="16" y2="6"/></svg>
        Graph
      </button>
      <button class="view-btn" data-view="info">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
        Info
      </button>
    </div>
  </div>
</div>

<main class="main">

  <!-- Networking Overview -->
  <div class="network-bar" data-layer-section="all">
    <div class="net-item">
      <div class="net-dot" style="background:var(--accent-cyan);color:var(--accent-cyan)"></div>
      <div>
        <div class="net-label">GCP Project</div>
        <div class="net-value">karma-beta-971006ad</div>
      </div>
    </div>
    <div class="net-sep"></div>
    <div class="net-item">
      <div class="net-dot" style="background:var(--accent-purple);color:var(--accent-purple)"></div>
      <div>
        <div class="net-label">Shared VPC</div>
        <div class="net-value">karma-shared-vpc-0c4a1bfe</div>
      </div>
    </div>
    <div class="net-sep"></div>
    <div class="net-item">
      <div class="net-dot" style="background:var(--accent-green);color:var(--accent-green)"></div>
      <div>
        <div class="net-label">VPC Connector</div>
        <div class="net-value">function-to-k8s</div>
      </div>
    </div>
    <div class="net-sep"></div>
    <div class="net-item">
      <div class="net-dot" style="background:var(--accent-orange);color:var(--accent-orange)"></div>
      <div>
        <div class="net-label">Container Registry</div>
        <div class="net-value">eu.gcr.io/karma-infrastructure</div>
      </div>
    </div>
    <div class="net-sep"></div>
    <div class="net-item">
      <div class="net-dot" style="background:var(--accent-pink);color:var(--accent-pink)"></div>
      <div>
        <div class="net-label">Region</div>
        <div class="net-value">europe-west1 (Belgium)</div>
      </div>
    </div>
  </div>

  <!-- FRONTEND LAYER -->
  <section class="layer" data-layer-section="frontend">
    <div class="layer-header">
      <div class="layer-indicator" style="background:var(--layer-frontend)"></div>
      <div class="layer-title" style="color:var(--layer-frontend)">Frontend & Web</div>
      <div class="layer-count">2 services</div>
      <div class="layer-desc">Firebase Hosting + GKE</div>
    </div>
    <div class="services-grid">
      <div class="service-card" data-layer="frontend" data-name="karma-merchant-web">
        <div class="card-top">
          <div>
            <div class="card-name">merchant-web</div>
            <div class="card-tech">React / Vite SPA</div>
          </div>
          <div class="card-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
          </div>
        </div>
        <div class="card-desc">Merchant backoffice dashboard. POS, inventory management, analytics, team management.</div>
        <div class="card-tags">
          <span class="card-tag">Firebase Hosting</span>
          <span class="card-tag">target: kfb-serve-beta</span>
        </div>
        <div class="card-url">serve.beta.karma.life</div>
      </div>

      <div class="service-card" data-layer="frontend" data-name="storefront-web">
        <div class="card-top">
          <div>
            <div class="card-name">storefront-web</div>
            <div class="card-tech">Next.js / SSR</div>
          </div>
          <div class="card-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
          </div>
        </div>
        <div class="card-desc">Consumer-facing ordering app. QR table orders, takeaway, room service, loyalty.</div>
        <div class="card-tags">
          <span class="card-tag">GKE</span>
          <span class="card-tag">Docker</span>
          <span class="card-tag">Port 3000</span>
          <span class="card-tag conn">WebSocket</span>
        </div>
        <div class="card-url">{slug}.store.beta.karma.life</div>
      </div>

    </div>
  </section>

  <div class="flow-indicator"><div class="flow-line"></div><div class="flow-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12l7 7 7-7"/></svg></div></div>

  <!-- API / GATEWAY LAYER -->
  <section class="layer" data-layer-section="gateway">
    <div class="layer-header">
      <div class="layer-indicator" style="background:var(--layer-gateway)"></div>
      <div class="layer-title" style="color:var(--layer-gateway)">API Layer</div>
      <div class="layer-count">3 services</div>
      <div class="layer-desc">GKE Kubernetes Cluster</div>
    </div>
    <div class="services-grid">
      <div class="service-card" data-layer="gateway" data-name="karma-merchant-api">
        <div class="card-top">
          <div>
            <div class="card-name">merchant-api</div>
            <div class="card-tech">Node.js / TypeScript / GraphQL</div>
          </div>
          <div class="card-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
          </div>
        </div>
        <div class="card-desc">Primary merchant-facing GraphQL API. Handles all merchant dashboard operations.</div>
        <div class="card-tags">
          <span class="card-tag">Port 8080</span>
          <span class="card-tag conn">PostgreSQL</span>
          <span class="card-tag conn">Pub/Sub</span>
        </div>
      </div>

      <div class="service-card" data-layer="gateway" data-name="karma-common-api">
        <div class="card-top">
          <div>
            <div class="card-name">karma-common-api</div>
            <div class="card-tech">Node.js / Fastify / REST</div>
          </div>
          <div class="card-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2"/><path d="M7 2v20M17 2v20M2 12h20"/></svg>
          </div>
        </div>
        <div class="card-desc">Centralized REST API. API key auth, rate limiting, webhook system. Scalar docs at /docs.</div>
        <div class="card-tags">
          <span class="card-tag">Port 8080</span>
          <span class="card-tag conn">PostgreSQL</span>
          <span class="card-tag conn">Redis</span>
          <span class="card-tag conn">BigQuery</span>
          <span class="card-tag conn">Pub/Sub</span>
        </div>
        <div class="card-url">10.100.0.10:8080 (internal LB)</div>
      </div>

      <div class="service-card" data-layer="gateway" data-name="karma-graph-api">
        <div class="card-top">
          <div>
            <div class="card-name">karma-graph-api</div>
            <div class="card-tech">Node.js / TypeScript / GraphQL</div>
          </div>
          <div class="card-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6M12 17v6M4.22 4.22l4.24 4.24M15.54 15.54l4.24 4.24M1 12h6M17 12h6M4.22 19.78l4.24-4.24M15.54 8.46l4.24-4.24"/></svg>
          </div>
        </div>
        <div class="card-desc">Consumer-facing GraphQL API. Aggregates mobile-api, merchant-api, delivery, box, user, giftcard services.</div>
        <div class="card-tags">
          <span class="card-tag">Port 8080</span>
          <span class="card-tag conn">PostgreSQL</span>
          <span class="card-tag conn">Pub/Sub</span>
          <span class="card-tag conn">K8s Services</span>
        </div>
      </div>
    </div>
  </section>

  <div class="flow-indicator"><div class="flow-line"></div><div class="flow-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12l7 7 7-7"/></svg></div></div>

  <!-- BACKEND SERVICES -->
  <section class="layer" data-layer-section="backend">
    <div class="layer-header">
      <div class="layer-indicator" style="background:var(--layer-backend)"></div>
      <div class="layer-title" style="color:var(--layer-backend)">Backend Services</div>
      <div class="layer-count">10 services</div>
      <div class="layer-desc">GKE Kubernetes Cluster — Docker containers</div>
    </div>
    <div class="services-grid">
      <div class="service-card" data-layer="backend" data-name="payment-service">
        <div class="card-top">
          <div>
            <div class="card-name">payment-service</div>
            <div class="card-tech">Node.js / TypeScript</div>
          </div>
          <div class="card-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/></svg>
          </div>
        </div>
        <div class="card-desc">Payment processing hub. Stripe, Adyen, Swish integration. Purchase lifecycle management.</div>
        <div class="card-tags">
          <span class="card-tag">Port 8080</span>
          <span class="card-tag conn">PostgreSQL</span>
          <span class="card-tag conn">Pub/Sub</span>
          <span class="card-tag conn">Stripe</span>
          <span class="card-tag conn">Adyen</span>
          <span class="card-tag conn">Swish</span>
        </div>
        <div class="card-url">payments.beta.karma.life</div>
      </div>

      <div class="service-card" data-layer="backend" data-name="storefront-service">
        <div class="card-top">
          <div>
            <div class="card-name">storefront-service</div>
            <div class="card-tech">Node.js / TypeScript</div>
          </div>
          <div class="card-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 7v13a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-3-5zM3 7h18"/></svg>
          </div>
        </div>
        <div class="card-desc">Core storefront business logic. Tab management, order processing, session handling.</div>
        <div class="card-tags">
          <span class="card-tag">Port 8080</span>
          <span class="card-tag conn">PostgreSQL</span>
          <span class="card-tag conn">Redis</span>
        </div>
      </div>

      <div class="service-card" data-layer="backend" data-name="karma-internal-api">
        <div class="card-top">
          <div>
            <div class="card-name">karma-internal-api</div>
            <div class="card-tech">Node.js / TypeScript</div>
          </div>
          <div class="card-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          </div>
        </div>
        <div class="card-desc">Internal service-to-service API. Private endpoints not exposed externally.</div>
        <div class="card-tags">
          <span class="card-tag">Port 8080</span>
          <span class="card-tag">Internal only</span>
        </div>
      </div>

      <div class="service-card" data-layer="backend" data-name="inventory-service">
        <div class="card-top">
          <div>
            <div class="card-name">inventory-service</div>
            <div class="card-tech">Node.js / TypeScript</div>
          </div>
          <div class="card-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
          </div>
        </div>
        <div class="card-desc">Product catalog and inventory management. Stock tracking and availability.</div>
        <div class="card-tags">
          <span class="card-tag">Port 8080</span>
          <span class="card-tag conn">PostgreSQL</span>
        </div>
      </div>

      <div class="service-card" data-layer="backend" data-name="payout-account-service">
        <div class="card-top">
          <div>
            <div class="card-name">payout-account-service</div>
            <div class="card-tech">Node.js / TypeScript</div>
          </div>
          <div class="card-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
          </div>
        </div>
        <div class="card-desc">Merchant payout account management and settlement processing.</div>
        <div class="card-tags">
          <span class="card-tag">Port 8080</span>
          <span class="card-tag conn">PostgreSQL</span>
        </div>
      </div>

      <div class="service-card" data-layer="backend" data-name="cash-register">
        <div class="card-top">
          <div>
            <div class="card-name">cash-register</div>
            <div class="card-tech">Node.js / TypeScript</div>
          </div>
          <div class="card-icon">CR</div>
        </div>
        <div class="card-desc">Cash register and receipt management for physical POS terminals.</div>
        <div class="card-tags">
          <span class="card-tag">Port 8080</span>
          <span class="card-tag conn">PostgreSQL</span>
        </div>
      </div>

      <div class="service-card" data-layer="backend" data-name="communication-service">
        <div class="card-top">
          <div>
            <div class="card-name">communication-service</div>
            <div class="card-tech">Node.js / TypeScript</div>
          </div>
          <div class="card-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          </div>
        </div>
        <div class="card-desc">Mail, Slack, and SMS communication services.</div>
        <div class="card-tags">
          <span class="card-tag">2 services</span>
          <span class="card-tag conn">Pub/Sub</span>
        </div>
      </div>

      <div class="service-card" data-layer="backend" data-name="pos-integrations-dispatcher">
        <div class="card-top">
          <div>
            <div class="card-name">pos-integrations-dispatcher</div>
            <div class="card-tech">Node.js / TypeScript</div>
          </div>
          <div class="card-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          </div>
        </div>
        <div class="card-desc">Dispatches orders to external POS systems and third-party integrations.</div>
        <div class="card-tags">
          <span class="card-tag">Port 8080</span>
          <span class="card-tag conn">Pub/Sub</span>
        </div>
      </div>

      <div class="service-card" data-layer="backend" data-name="printer-service">
        <div class="card-top">
          <div>
            <div class="card-name">printer-service</div>
            <div class="card-tech">Node.js / TypeScript</div>
          </div>
          <div class="card-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
          </div>
        </div>
        <div class="card-desc">Cloud functions for receipt and kitchen ticket printing.</div>
        <div class="card-tags">
          <span class="card-tag">Cloud Functions</span>
          <span class="card-tag conn">Pub/Sub</span>
        </div>
      </div>
    </div>
  </section>

  <div class="flow-indicator"><div class="flow-line"></div><div class="flow-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12l7 7 7-7"/></svg></div></div>

  <!-- CLOUD FUNCTIONS -->
  <section class="layer" data-layer-section="functions">
    <div class="layer-header">
      <div class="layer-indicator" style="background:var(--layer-functions)"></div>
      <div class="layer-title" style="color:var(--layer-functions)">Cloud Functions</div>
      <div class="layer-count">28+ functions</div>
      <div class="layer-desc">Gen 2 / europe-west1 / Pub/Sub & HTTP triggers</div>
    </div>
    <div class="func-grid">
      <div class="func-group" data-name="common-functions">
        <div class="func-group-header">
          <div class="func-group-icon">CF</div>
          <div class="func-group-title">common functions</div>
          <div class="func-group-count">10 functions</div>
        </div>
        <div class="func-list">
          <span class="func-item" data-name="cf-webhook-delivery">cf-webhook-delivery</span>
          <span class="func-item" data-name="cf-stale-payment-cleanup">cf-stale-payment-cleanup</span>
          <span class="func-item" data-name="cf-voucher-reservation-expiry">cf-voucher-reservation-expiry</span>
          <span class="func-item" data-name="cf-handle-tab-payment-received">cf-handle-tab-payment</span>
          <span class="func-item" data-name="cf-loyalty-scheduled-function">cf-loyalty-scheduled</span>
          <span class="func-item" data-name="cf-kitchen-dispatch-updated">cf-kitchen-dispatch-updated</span>
          <span class="func-item" data-name="cf-kitchen-dispatch-merge-staggered">cf-kitchen-dispatch-merge</span>
          <span class="func-item" data-name="cf-kitchen-dispatch-action-timeout">cf-kitchen-dispatch-timeout</span>
          <span class="func-item" data-name="cf-kitchen-dispatch-accept-scheduled">cf-kitchen-dispatch-accept</span>
          <span class="func-item" data-name="cf-tab-auto-close">cf-tab-auto-close</span>
        </div>
      </div>

      <div class="func-group" data-name="printer-functions payout-report-functions">
        <div class="func-group-header">
          <div class="func-group-icon">+</div>
          <div class="func-group-title">other functions</div>
          <div class="func-group-count">2 repos</div>
        </div>
        <div class="func-list">
          <span class="func-item" data-name="printer-functions">printer-functions <span class="func-trigger">receipt printing</span></span>
          <span class="func-item" data-name="payout-report-functions">payout-report-functions <span class="func-trigger">reports</span></span>
        </div>
      </div>
    </div>
  </section>

  <div class="flow-indicator"><div class="flow-line"></div><div class="flow-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12l7 7 7-7"/></svg></div></div>

  <!-- DATA LAYER -->
  <section class="layer" data-layer-section="data">
    <div class="layer-header">
      <div class="layer-indicator" style="background:var(--layer-data)"></div>
      <div class="layer-title" style="color:var(--layer-data)">Data Layer</div>
      <div class="layer-count">4 stores</div>
      <div class="layer-desc">Managed GCP data services</div>
    </div>
    <div class="services-grid">
      <div class="service-card" data-layer="data" data-name="postgresql cloud-sql">
        <div class="card-top">
          <div>
            <div class="card-name">postgresql</div>
            <div class="card-tech">Cloud SQL</div>
          </div>
          <div class="card-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
          </div>
        </div>
        <div class="card-desc">Primary transactional database. Shared karma database with all services via VPC connector.</div>
        <div class="card-tags">
          <span class="card-tag">karma db</span>
          <span class="card-tag">Shared VPC</span>
          <span class="card-tag">OLTP</span>
        </div>
      </div>

      <div class="service-card" data-layer="data" data-name="redis memorystore">
        <div class="card-top">
          <div>
            <div class="card-name">redis</div>
            <div class="card-tech">Memorystore</div>
          </div>
          <div class="card-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
          </div>
        </div>
        <div class="card-desc">In-memory cache. Rate limiting, session storage, real-time data caching.</div>
        <div class="card-tags">
          <span class="card-tag">10.0.80.20:6379</span>
          <span class="card-tag">Shared</span>
        </div>
      </div>

      <div class="service-card" data-layer="data" data-name="bigquery analytics">
        <div class="card-top">
          <div>
            <div class="card-name">bigquery</div>
            <div class="card-tech">Data Warehouse</div>
          </div>
          <div class="card-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/><path d="M9 12l2 2 4-4"/></svg>
          </div>
        </div>
        <div class="card-desc">Historical analytics. CDC replication from PostgreSQL. Routes queries >24h to BigQuery automatically.</div>
        <div class="card-tags">
          <span class="card-tag">analytics_eupublic</span>
          <span class="card-tag">analytics_reporting</span>
          <span class="card-tag">OLAP</span>
        </div>
      </div>

      <div class="service-card" data-layer="data" data-name="pub/sub pubsub">
        <div class="card-top">
          <div>
            <div class="card-name">pub/sub</div>
            <div class="card-tech">Message Queue</div>
          </div>
          <div class="card-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
          </div>
        </div>
        <div class="card-desc">Event-driven messaging. Triggers Cloud Functions, async webhook delivery, PSP event processing.</div>
        <div class="card-tags">
          <span class="card-tag">Async events</span>
          <span class="card-tag">Function triggers</span>
          <span class="card-tag">Webhooks</span>
        </div>
      </div>
    </div>
  </section>

  <div class="flow-indicator"><div class="flow-line"></div><div class="flow-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12l7 7 7-7"/></svg></div></div>

  <!-- EXTERNAL INTEGRATIONS -->
  <section class="layer" data-layer-section="external">
    <div class="layer-header">
      <div class="layer-indicator" style="background:var(--layer-external)"></div>
      <div class="layer-title" style="color:var(--layer-external)">External Integrations</div>
      <div class="layer-count">6 services</div>
      <div class="layer-desc">Third-party APIs and SaaS</div>
    </div>
    <div class="services-grid compact">
      <div class="service-card" data-layer="external" data-name="adyen">
        <div class="card-top">
          <div>
            <div class="card-name">adyen</div>
            <div class="card-tech">Payment PSP</div>
          </div>
          <div class="card-icon">A</div>
        </div>
        <div class="card-desc">Primary payment processor. Card payments, terminals, payouts.</div>
      </div>
      <div class="service-card" data-layer="external" data-name="stripe">
        <div class="card-top">
          <div>
            <div class="card-name">stripe</div>
            <div class="card-tech">Payment PSP</div>
          </div>
          <div class="card-icon">S</div>
        </div>
        <div class="card-desc">Secondary payment processor. Online payments and subscriptions.</div>
      </div>
      <div class="service-card" data-layer="external" data-name="swish">
        <div class="card-top">
          <div>
            <div class="card-name">swish</div>
            <div class="card-tech">Mobile Payments</div>
          </div>
          <div class="card-icon">Sw</div>
        </div>
        <div class="card-desc">Swedish mobile payment system for instant P2P and merchant payments.</div>
      </div>
      <div class="service-card" data-layer="external" data-name="sentry">
        <div class="card-top">
          <div>
            <div class="card-name">sentry</div>
            <div class="card-tech">Error Monitoring</div>
          </div>
          <div class="card-icon">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          </div>
        </div>
        <div class="card-desc">Real-time error tracking across all services.</div>
      </div>
      <div class="service-card" data-layer="external" data-name="prometheus">
        <div class="card-top">
          <div>
            <div class="card-name">prometheus</div>
            <div class="card-tech">Metrics</div>
          </div>
          <div class="card-icon">P</div>
        </div>
        <div class="card-desc">Metrics collection and monitoring at :9090/metrics.</div>
      </div>
      <div class="service-card" data-layer="external" data-name="google-maps">
        <div class="card-top">
          <div>
            <div class="card-name">google maps</div>
            <div class="card-tech">Maps API</div>
          </div>
          <div class="card-icon">G</div>
        </div>
        <div class="card-desc">Location mapping and geocoding for storefronts.</div>
      </div>
    </div>
  </section>

  <div class="flow-indicator"><div class="flow-line"></div><div class="flow-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12l7 7 7-7"/></svg></div></div>

  <!-- CI/CD -->
  <section class="layer" data-layer-section="cicd">
    <div class="layer-header">
      <div class="layer-indicator" style="background:var(--layer-cicd)"></div>
      <div class="layer-title" style="color:var(--layer-cicd)">CI/CD Pipeline</div>
      <div class="layer-count">3 tools</div>
      <div class="layer-desc">Deployment & orchestration</div>
    </div>
    <div class="services-grid">
      <div class="service-card" data-layer="cicd" data-name="github-actions">
        <div class="card-top">
          <div>
            <div class="card-name">github actions</div>
            <div class="card-tech">CI/CD Pipelines</div>
          </div>
          <div class="card-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v3M12 20v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M1 12h3M20 12h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12"/></svg>
          </div>
        </div>
        <div class="card-desc">Build, test, and deploy pipelines. Triggered by git tags (dev-*, v*) or push to beta branch.</div>
        <div class="card-tags">
          <span class="card-tag">Tag triggers</span>
          <span class="card-tag">Beta branch</span>
          <span class="card-tag">Docker build</span>
        </div>
      </div>

      <div class="service-card" data-layer="cicd" data-name="argocd">
        <div class="card-top">
          <div>
            <div class="card-name">argocd</div>
            <div class="card-tech">GitOps / K8s Sync</div>
          </div>
          <div class="card-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
          </div>
        </div>
        <div class="card-desc">Kubernetes GitOps controller. Syncs desired state from git to GKE cluster automatically.</div>
        <div class="card-tags">
          <span class="card-tag">GitOps</span>
          <span class="card-tag">Auto-sync</span>
        </div>
        <div class="card-url">argocd.karma.life</div>
      </div>

      <div class="service-card" data-layer="cicd" data-name="gcr container-registry">
        <div class="card-top">
          <div>
            <div class="card-name">container registry</div>
            <div class="card-tech">eu.gcr.io</div>
          </div>
          <div class="card-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2"/><path d="M7 2v20M17 2v20M2 7h20M2 17h20"/></svg>
          </div>
        </div>
        <div class="card-desc">Docker image registry on Google Cloud. Stores all service container images.</div>
        <div class="card-tags">
          <span class="card-tag">eu.gcr.io/karma-infrastructure</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Stats -->
  <div class="stats-bar">
    <div class="stat">
      <div class="stat-val">15</div>
      <div class="stat-label">K8s Services</div>
    </div>
    <div class="stat">
      <div class="stat-val">28+</div>
      <div class="stat-label">Cloud Functions</div>
    </div>
    <div class="stat">
      <div class="stat-val">2</div>
      <div class="stat-label">Firebase Apps</div>
    </div>
    <div class="stat">
      <div class="stat-val">4</div>
      <div class="stat-label">Data Stores</div>
    </div>
    <div class="stat">
      <div class="stat-val">6</div>
      <div class="stat-label">External APIs</div>
    </div>
    <div class="stat">
      <div class="stat-val">3</div>
      <div class="stat-label">GCP Projects</div>
    </div>
  </div>

</main>

<!-- Info View -->
<div class="info-container" id="infoContainer">

  <div class="info-hero">
    <h1>Karma Platform Architecture</h1>
    <p>Karma is a cloud-native, microservices-based hospitality platform running on Google Cloud Platform (GCP). The system is built around a centralized REST API layer, an event-driven Pub/Sub backbone, and a configurable webhook system — enabling real-time data flow between all internal services and external integrations.</p>
  </div>

  <div class="info-grid">

    <div class="info-section">
      <div class="info-section-icon" style="background:rgba(79,140,255,0.1);color:var(--accent-blue)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2"/><path d="M7 2v20M17 2v20M2 12h20"/></svg>
      </div>
      <h2>API Layer</h2>
      <p>All platform data is exposed through RESTful APIs built with Fastify (common-api) and GraphQL (merchant-api). The common-api serves as the unified entry point for inventory, orders, loyalty, and checkout operations. APIs are OpenAPI-documented with interactive Scalar docs, use standard HTTP methods, and return consistent JSON responses.</p>
      <ul class="info-list">
        <li><strong>Authentication:</strong> JWT-based user tokens and long-lived API keys with granular permission scoping for service-to-service integration</li>
        <li><strong>Rate limiting:</strong> Redis-backed per-key rate limiting protects all endpoints</li>
        <li><strong>Standards:</strong> OpenAPI 3.0 schemas, standard HTTP status codes, pagination via cursor-based tokens</li>
        <li><strong>SDK:</strong> JavaScript/TypeScript SDK available on npm — the only provider offering a native SDK</li>
      </ul>
      <div style="margin-top:12px">
        <span class="info-tag">REST</span>
        <span class="info-tag">GraphQL</span>
        <span class="info-tag">OpenAPI 3.0</span>
        <span class="info-tag">Scalar Docs</span>
        <span class="info-tag">JWT</span>
        <span class="info-tag">API Keys</span>
      </div>
    </div>

    <div class="info-section">
      <div class="info-section-icon" style="background:rgba(251,146,60,0.1);color:var(--accent-orange)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
      </div>
      <h2>Event-Driven Architecture</h2>
      <p>All business events are broadcast through Google Cloud Pub/Sub, creating a decoupled, asynchronous backbone. When an order is placed, a payment completes, or inventory changes, events are published to topic channels and consumed by downstream services and Cloud Functions.</p>
      <ul class="info-list">
        <li><strong>Message queue:</strong> Google Cloud Pub/Sub with at-least-once delivery guarantees</li>
        <li><strong>Event types:</strong> Order lifecycle (created, updated, completed), payment events (authorized, captured, refunded), inventory changes, tab updates, kitchen dispatch</li>
        <li><strong>Cloud Functions:</strong> 27+ serverless functions triggered by Pub/Sub for async processing — kitchen dispatch, tab management, email notifications, report generation</li>
        <li><strong>Guaranteed delivery:</strong> Events are persisted and retried automatically, ensuring no data loss during peak loads or temporary outages</li>
      </ul>
      <div style="margin-top:12px">
        <span class="info-tag">Pub/Sub</span>
        <span class="info-tag">Cloud Functions</span>
        <span class="info-tag">At-least-once</span>
        <span class="info-tag">Async</span>
      </div>
    </div>

    <div class="info-section">
      <div class="info-section-icon" style="background:rgba(52,211,153,0.1);color:var(--accent-green)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      </div>
      <h2>Webhook System</h2>
      <p>Configurable webhooks push real-time notifications to external systems whenever business events occur. Integrators subscribe to specific event types and receive HTTP POST callbacks with signed payloads — enabling seamless connections to ERP systems, accounting software, BI platforms, and custom middleware.</p>
      <ul class="info-list">
        <li><strong>Delivery:</strong> HTTP POST with JSON payloads to any endpoint, with configurable event subscriptions</li>
        <li><strong>Security:</strong> HMAC signature verification on every payload for tamper-proof authenticity</li>
        <li><strong>Resilience:</strong> Automatic retry with exponential backoff — failed deliveries are retried with increasing intervals</li>
        <li><strong>Management:</strong> Webhook configuration via API and merchant dashboard. Full delivery logs with status tracking</li>
      </ul>
      <div style="margin-top:12px">
        <span class="info-tag">HMAC Signatures</span>
        <span class="info-tag">Retry Logic</span>
        <span class="info-tag">Configurable Events</span>
      </div>
    </div>

    <div class="info-section">
      <div class="info-section-icon" style="background:rgba(167,139,250,0.1);color:var(--accent-purple)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="8" rx="2"/><rect x="2" y="14" width="20" height="8" rx="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>
      </div>
      <h2>Infrastructure & Orchestration</h2>
      <p>The platform runs entirely on Google Cloud Platform in the europe-west1 (Belgium) region. All backend services are containerized with Docker and orchestrated on Google Kubernetes Engine (GKE), with GitOps-driven deployments through ArgoCD.</p>
      <ul class="info-list">
        <li><strong>Container orchestration:</strong> GKE with auto-scaling, self-healing, and rolling deployments</li>
        <li><strong>CI/CD:</strong> GitHub Actions builds and tests on every push. ArgoCD syncs desired state from git to the cluster automatically</li>
        <li><strong>Networking:</strong> Shared VPC with internal load balancers for service-to-service communication. VPC connector bridges Cloud Functions to K8s services and databases</li>
        <li><strong>Environments:</strong> Isolated GCP projects for development, beta, and production with identical infrastructure</li>
      </ul>
      <div style="margin-top:12px">
        <span class="info-tag">GKE</span>
        <span class="info-tag">Docker</span>
        <span class="info-tag">ArgoCD</span>
        <span class="info-tag">GitHub Actions</span>
        <span class="info-tag">Shared VPC</span>
      </div>
    </div>

    <div class="info-section">
      <div class="info-section-icon" style="background:rgba(244,114,182,0.1);color:var(--accent-pink)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
      </div>
      <h2>Data Layer & Analytics</h2>
      <p>Transactional data lives in PostgreSQL (Cloud SQL), with Redis (Memorystore) for caching and session storage. For analytics and BI, Change Data Capture (CDC) via Google Cloud Datastream continuously replicates transactional data to BigQuery in near real-time.</p>
      <ul class="info-list">
        <li><strong>Database:</strong> PostgreSQL 16 (Cloud SQL) — primary transactional store for all services</li>
        <li><strong>Caching:</strong> Redis for session storage, rate limiting, and performance optimization</li>
        <li><strong>Data warehouse:</strong> BigQuery for analytics, reporting, and BI. Queries older than 24h are automatically routed to BigQuery</li>
        <li><strong>CDC replication:</strong> Datastream continuously syncs PostgreSQL to BigQuery — fresh data for BI without impacting operational systems</li>
        <li><strong>BI connectors:</strong> Standard BigQuery connectivity for Power BI, Tableau, Looker, and other analytics platforms</li>
      </ul>
      <div style="margin-top:12px">
        <span class="info-tag">PostgreSQL 16</span>
        <span class="info-tag">Redis</span>
        <span class="info-tag">BigQuery</span>
        <span class="info-tag">CDC / Datastream</span>
      </div>
    </div>

    <div class="info-section">
      <div class="info-section-icon" style="background:rgba(251,191,36,0.1);color:var(--accent-yellow)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/></svg>
      </div>
      <h2>Payment Processing</h2>
      <p>A dedicated payment-service handles the full payment lifecycle across multiple providers. All payment events are broadcast via Pub/Sub, enabling downstream services (receipts, kitchen dispatch, loyalty) to react in real-time.</p>
      <ul class="info-list">
        <li><strong>Adyen:</strong> Enterprise-grade card payments, payment terminals, multi-currency support, and merchant payouts</li>
        <li><strong>Stripe:</strong> Full payment lifecycle — authorizations, captures, refunds, and dispute management</li>
        <li><strong>Swish:</strong> Native mobile payment integration for Nordic markets</li>
        <li><strong>Lifecycle:</strong> Centralized purchase tracking from authorization through settlement, with automatic reconciliation</li>
      </ul>
      <div style="margin-top:12px">
        <span class="info-tag">Adyen</span>
        <span class="info-tag">Stripe</span>
        <span class="info-tag">Swish</span>
        <span class="info-tag">Multi-PSP</span>
      </div>
    </div>

    <div class="info-section">
      <div class="info-section-icon" style="background:rgba(233,69,96,0.1);color:var(--accent-cyan)">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
      </div>
      <h2>Frontend Applications</h2>
      <p>Two primary web applications serve different user groups, both optimized for their target devices and use cases.</p>
      <ul class="info-list">
        <li><strong>Guest-facing (storefront-web):</strong> Next.js progressive web app for QR-based table ordering, takeaway, and room service. Mobile-first, fast loading, real-time order status via WebSocket</li>
        <li><strong>Staff-facing (merchant-web):</strong> React SPA for the merchant backoffice — POS, inventory management, analytics, and team management. Tablet-optimized with touch-first design for hospitality operations</li>
        <li><strong>Kitchen Display:</strong> Real-time order routing to kitchen screens with preparation workflow management and automatic dispatch</li>
      </ul>
    </div>

    <div class="info-section">
      <div class="info-section-icon" style="background:rgba(248,113,113,0.1);color:var(--accent-red)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
      </div>
      <h2>Integration Capabilities</h2>
      <p>The platform is designed for seamless integration with external systems. Our API and event-based architecture means most integrations are as simple as connecting through a platform like n8n or Zapier.</p>
      <ul class="info-list">
        <li><strong>Printer integration:</strong> Direct integration with Epson, Star Micronics, and network printers for receipt and kitchen ticket printing via CloudPRNT</li>
        <li><strong>POS integrations:</strong> Dedicated dispatcher service routes orders to external POS systems and third-party platforms</li>
        <li><strong>ERP/BI:</strong> REST API access to all business objects (orders, inventory, customers, transactions) with BigQuery export for analytics</li>
        <li><strong>Timeline:</strong> Simple integrations (payment providers, accounting) in 1-2 weeks. Complex integrations (ERP, custom middleware) in 4-6 weeks</li>
      </ul>
      <div style="margin-top:12px">
        <span class="info-tag">REST API</span>
        <span class="info-tag">Webhooks</span>
        <span class="info-tag">JS SDK</span>
        <span class="info-tag">BigQuery Export</span>
        <span class="info-tag">n8n / Zapier</span>
      </div>
    </div>

  </div>

  <!-- Webhook & Realtime Events Reference -->
  <div style="margin-top:8px">
    <h2 style="font-size:15px;font-weight:700;margin-bottom:8px;letter-spacing:-0.01em">Webhook & realtime events</h2>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px">All available event types that can be subscribed to via webhooks or received through realtime WebSocket connections. Events are grouped by domain.</p>

    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px">

      <div class="info-section" style="padding:20px">
        <h2 style="font-size:13px;margin-bottom:10px;color:var(--accent-orange)">Order</h2>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          <span class="info-tag">Created</span>
          <span class="info-tag">Updated</span>
          <span class="info-tag">Completed</span>
          <span class="info-tag">Cancelled</span>
          <span class="info-tag">Accepted</span>
          <span class="info-tag">Rejected</span>
          <span class="info-tag">Ready</span>
          <span class="info-tag">Items Added</span>
          <span class="info-tag">Items Status Changed</span>
          <span class="info-tag">Payment Required</span>
        </div>
      </div>

      <div class="info-section" style="padding:20px">
        <h2 style="font-size:13px;margin-bottom:10px;color:var(--accent-blue)">Tab</h2>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          <span class="info-tag">Opened</span>
          <span class="info-tag">Updated</span>
          <span class="info-tag">Closed</span>
          <span class="info-tag">Member Added</span>
          <span class="info-tag">Item Claimed</span>
          <span class="info-tag">Item Unclaimed</span>
          <span class="info-tag">Items Locked</span>
          <span class="info-tag">Items Unlocked</span>
          <span class="info-tag">Payment Initiated</span>
          <span class="info-tag">Payment Completed</span>
          <span class="info-tag">Payment Failed</span>
        </div>
      </div>

      <div class="info-section" style="padding:20px">
        <h2 style="font-size:13px;margin-bottom:10px;color:var(--accent-cyan)">Inventory</h2>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          <span class="info-tag">Created</span>
          <span class="info-tag">Updated</span>
          <span class="info-tag">Deleted</span>
        </div>
      </div>

      <div class="info-section" style="padding:20px">
        <h2 style="font-size:13px;margin-bottom:10px;color:var(--accent-cyan)">Article</h2>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          <span class="info-tag">Created</span>
          <span class="info-tag">Updated</span>
          <span class="info-tag">Deleted</span>
          <span class="info-tag">Published</span>
          <span class="info-tag">Availability Changed</span>
        </div>
      </div>

      <div class="info-section" style="padding:20px">
        <h2 style="font-size:13px;margin-bottom:10px;color:var(--accent-purple)">Variant Group</h2>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          <span class="info-tag">Created</span>
          <span class="info-tag">Updated</span>
          <span class="info-tag">Deleted</span>
        </div>
      </div>

      <div class="info-section" style="padding:20px">
        <h2 style="font-size:13px;margin-bottom:10px;color:var(--accent-purple)">Variant</h2>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          <span class="info-tag">Created</span>
          <span class="info-tag">Updated</span>
          <span class="info-tag">Deleted</span>
          <span class="info-tag">Item Linked</span>
          <span class="info-tag">Item Unlinked</span>
        </div>
      </div>

      <div class="info-section" style="padding:20px">
        <h2 style="font-size:13px;margin-bottom:10px;color:var(--accent-green)">Channel</h2>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          <span class="info-tag">Created</span>
          <span class="info-tag">Updated</span>
          <span class="info-tag">Deleted</span>
          <span class="info-tag">Assignment Created</span>
          <span class="info-tag">Assignment Updated</span>
          <span class="info-tag">Assignment Deleted</span>
        </div>
      </div>

      <div class="info-section" style="padding:20px">
        <h2 style="font-size:13px;margin-bottom:10px;color:var(--accent-green)">Schedule</h2>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          <span class="info-tag">Created</span>
          <span class="info-tag">Updated</span>
          <span class="info-tag">Deleted</span>
          <span class="info-tag">Rule Created</span>
          <span class="info-tag">Rule Updated</span>
          <span class="info-tag">Rule Deleted</span>
          <span class="info-tag">Location Hours Updated</span>
        </div>
      </div>

      <div class="info-section" style="padding:20px">
        <h2 style="font-size:13px;margin-bottom:10px;color:var(--accent-pink)">Booking</h2>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          <span class="info-tag">Created</span>
          <span class="info-tag">Confirmed</span>
          <span class="info-tag">Updated</span>
          <span class="info-tag">Cancelled</span>
          <span class="info-tag">Seated</span>
          <span class="info-tag">Completed</span>
          <span class="info-tag">No Show</span>
        </div>
      </div>

      <div class="info-section" style="padding:20px">
        <h2 style="font-size:13px;margin-bottom:10px;color:var(--accent-pink)">Waitlist</h2>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          <span class="info-tag">Joined</span>
          <span class="info-tag">Notified</span>
          <span class="info-tag">Converted</span>
          <span class="info-tag">Removed</span>
        </div>
      </div>

      <div class="info-section" style="padding:20px">
        <h2 style="font-size:13px;margin-bottom:10px;color:var(--accent-yellow)">Payment</h2>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          <span class="info-tag">Completed</span>
          <span class="info-tag">Failed</span>
          <span class="info-tag">Cancelled</span>
          <span class="info-tag">Refund Completed</span>
          <span class="info-tag">Refund Failed</span>
        </div>
      </div>

      <div class="info-section" style="padding:20px">
        <h2 style="font-size:13px;margin-bottom:10px;color:var(--accent-pink)">Menu Layout</h2>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          <span class="info-tag">Created</span>
          <span class="info-tag">Updated</span>
          <span class="info-tag">Deleted</span>
        </div>
      </div>

      <div class="info-section" style="padding:20px">
        <h2 style="font-size:13px;margin-bottom:10px;color:var(--accent-pink)">Print Template</h2>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          <span class="info-tag">Created</span>
          <span class="info-tag">Updated</span>
          <span class="info-tag">Deleted</span>
          <span class="info-tag">Print Settings Updated</span>
          <span class="info-tag">Override Updated</span>
        </div>
      </div>

      <div class="info-section" style="padding:20px">
        <h2 style="font-size:13px;margin-bottom:10px;color:var(--accent-red)">Alert</h2>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          <span class="info-tag">Created</span>
          <span class="info-tag">Updated</span>
        </div>
      </div>

      <div class="info-section" style="padding:20px">
        <h2 style="font-size:13px;margin-bottom:10px;color:var(--accent-blue)">Table</h2>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          <span class="info-tag">Updated</span>
        </div>
      </div>

      <div class="info-section" style="padding:20px">
        <h2 style="font-size:13px;margin-bottom:10px;color:var(--accent-blue)">Table Group</h2>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          <span class="info-tag">Created</span>
          <span class="info-tag">Updated</span>
          <span class="info-tag">Deleted</span>
        </div>
      </div>

      <div class="info-section" style="padding:20px">
        <h2 style="font-size:13px;margin-bottom:10px;color:var(--accent-blue)">Location Map</h2>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          <span class="info-tag">Created</span>
          <span class="info-tag">Updated</span>
          <span class="info-tag">Deleted</span>
        </div>
      </div>

      <div class="info-section" style="padding:20px">
        <h2 style="font-size:13px;margin-bottom:10px;color:var(--accent-orange)">Cost Center</h2>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          <span class="info-tag">Created</span>
          <span class="info-tag">Updated</span>
          <span class="info-tag">Deleted</span>
        </div>
      </div>

      <div class="info-section" style="padding:20px">
        <h2 style="font-size:13px;margin-bottom:10px;color:var(--accent-yellow)">API Key</h2>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          <span class="info-tag">Created</span>
          <span class="info-tag">Updated</span>
          <span class="info-tag">Revoked</span>
        </div>
      </div>

    </div>
  </div>

  <!-- Data Flow Diagrams -->
  <div style="margin-top:8px">
    <h2 style="font-size:15px;font-weight:700;margin-bottom:8px;letter-spacing:-0.01em">Guest order flow (QR / online)</h2>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px">A guest scans a QR code or opens the storefront, browses the menu, places an order, and pays. Events fan out asynchronously.</p>
    <div class="flow-diagram" id="flowDiagram"></div>
  </div>

  <div style="margin-top:32px">
    <h2 style="font-size:15px;font-weight:700;margin-bottom:8px;letter-spacing:-0.01em">POS order flow (staff-initiated)</h2>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px">A staff member takes an order on the merchant POS tablet, processes payment at the terminal, and the system handles dispatch and receipts.</p>
    <div class="flow-diagram" id="flowDiagramPOS"></div>
  </div>

</div>

<!-- Graph View -->
<div class="graph-container" id="graphContainer">
  <svg id="graphSvg">
    <defs>
      <marker id="arrowApi" viewBox="0 0 10 6" refX="10" refY="3" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
        <path d="M0,0 L10,3 L0,6" fill="var(--accent-cyan)" opacity="0.5"/>
      </marker>
      <marker id="arrowEvent" viewBox="0 0 10 6" refX="10" refY="3" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
        <path d="M0,0 L10,3 L0,6" fill="var(--accent-orange)" opacity="0.5"/>
      </marker>
      <marker id="arrowMonitor" viewBox="0 0 10 6" refX="10" refY="3" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
        <path d="M0,0 L10,3 L0,6" fill="var(--accent-yellow)" opacity="0.5"/>
      </marker>
    </defs>
    <g id="graphWorld">
      <g id="edgesGroup"></g>
      <g id="nodesGroup"></g>
    </g>
  </svg>
</div>

<!-- Graph Detail Panel -->
<div class="graph-detail" id="graphDetail">
  <button class="detail-close" id="detailClose">&times;</button>
  <div id="detailContent"></div>
</div>

<!-- Graph Legend -->
<div class="graph-legend" id="graphLegend">
  <div class="legend-group">
    <div class="legend-title">Connection Type</div>
    <div class="legend-item"><span class="legend-line solid"></span>Direct API</div>
    <div class="legend-item"><span class="legend-line dashed"></span>Event / Pub/Sub</div>
    <div class="legend-item"><span class="legend-line dotted"></span>Monitoring</div>
  </div>
  <div class="legend-group">
    <div class="legend-title">Service Layer</div>
    <div class="legend-item"><span class="legend-dot" style="background:var(--layer-frontend)"></span>Frontend</div>
    <div class="legend-item"><span class="legend-dot" style="background:var(--layer-gateway)"></span>API Layer</div>
    <div class="legend-item"><span class="legend-dot" style="background:var(--layer-backend)"></span>Backend</div>
    <div class="legend-item"><span class="legend-dot" style="background:var(--layer-functions)"></span>Functions</div>
    <div class="legend-item"><span class="legend-dot" style="background:var(--layer-data)"></span>Data</div>
    <div class="legend-item"><span class="legend-dot" style="background:var(--layer-external)"></span>External</div>
  </div>
</div>

<!-- Zoom Controls -->
<div class="graph-zoom-controls" id="graphZoomControls">
  <button class="zoom-btn" id="zoomIn">+</button>
  <button class="zoom-btn" id="zoomOut">&minus;</button>
  <button class="zoom-btn" id="zoomReset" style="font-size:11px">&#8634;</button>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
  // =============================
  // FLOW DIAGRAM
  // =============================
  (function buildFlowDiagram() {
    const container = document.getElementById('flowDiagram');
    if (!container) return;

    const SW = 130, SH = 46, GAP = 36, BRANCHGAP = 56;
    const colors = {
      frontend: '#5b9cf5',
      gateway: '#a78bfa',
      backend: '#e94560',
      functions: '#fb923c',
      data: '#f472b6',
      external: '#fbbf24',
    };

    // Main flow steps (left to right)
    const mainSteps = [
      { label: 'Guest scans QR', sub: 'table / takeaway', color: colors.frontend },
      { label: 'storefront-web', sub: 'Next.js PWA', color: colors.frontend },
      { label: 'common-api', sub: 'menu & cart', color: colors.gateway },
      { label: 'payment-service', sub: 'checkout', color: colors.backend },
      { label: 'pub/sub', sub: 'payment event', color: colors.data },
    ];

    // Branches from pub/sub (step index 4)
    const branches = [
      { label: 'kitchen dispatch', sub: 'Cloud Function', color: colors.functions },
      { label: 'receipt printing', sub: 'Cloud Function', color: colors.functions },
      { label: 'webhooks', sub: 'ERP / POS / accounting', color: colors.external },
      { label: 'merchant-web', sub: 'real-time WebSocket', color: colors.frontend },
      { label: 'bigquery', sub: 'CDC replication', color: colors.data },
    ];

    const mainY = 40;
    const branchStartX = (mainSteps.length - 1) * (SW + GAP);
    const branchY = mainY + SH + BRANCHGAP;
    const totalBranchW = branches.length * SW + (branches.length - 1) * 16;
    const branchStartLeft = branchStartX - totalBranchW / 2 + SW / 2;

    const svgW = Math.max(mainSteps.length * (SW + GAP), branchStartLeft + totalBranchW + 40) + 40;
    const svgH = branchY + SH + 50;

    let svg = `<svg width="${svgW}" height="${svgH}" viewBox="0 0 ${svgW} ${svgH}" xmlns="http://www.w3.org/2000/svg">`;
    svg += `<defs><marker id="flowArrow" viewBox="0 0 10 6" refX="10" refY="3" markerWidth="7" markerHeight="5" orient="auto-start-reverse"><path d="M0,0 L10,3 L0,6" fill="#1a4a7a"/></marker></defs>`;

    // Phase labels
    const phases = [
      { x: 0 * (SW + GAP) + SW / 2 + 20, label: 'trigger' },
      { x: 1.5 * (SW + GAP) + SW / 2 + 20, label: 'ordering' },
      { x: 3 * (SW + GAP) + SW / 2 + 20, label: 'payment' },
      { x: 4 * (SW + GAP) + SW / 2 + 20, label: 'events' },
    ];
    phases.forEach(p => {
      svg += `<text class="flow-phase-label" x="${p.x}" y="18">${p.label}</text>`;
    });

    // Main flow
    mainSteps.forEach((step, i) => {
      const x = 20 + i * (SW + GAP);
      const cx = x + SW / 2;
      const cy = mainY + SH / 2;

      // Arrow to next step
      if (i < mainSteps.length - 1) {
        const x1 = x + SW + 4;
        const x2 = x + SW + GAP - 4;
        svg += `<line class="flow-arrow-line" x1="${x1}" y1="${mainY + SH/2}" x2="${x2}" y2="${mainY + SH/2}"/>`;
      }

      // Step box
      svg += `<g class="flow-step">`;
      svg += `<rect class="flow-step-rect" x="${x}" y="${mainY}" width="${SW}" height="${SH}" fill="${step.color}15" stroke="${step.color}" stroke-width="1.2"/>`;
      svg += `<text class="flow-step-label" x="${cx}" y="${cy - 6}">${step.label}</text>`;
      svg += `<text class="flow-step-sub" x="${cx}" y="${cy + 9}">${step.sub}</text>`;
      svg += `</g>`;
    });

    // Branches from pub/sub
    const pubsubCx = 20 + (mainSteps.length - 1) * (SW + GAP) + SW / 2;
    const pubsubBottom = mainY + SH;

    branches.forEach((branch, i) => {
      const bx = branchStartLeft + i * (SW + 16);
      const bcx = bx + SW / 2;
      const bcy = branchY + SH / 2;

      // Branch line from pub/sub
      const startY = pubsubBottom + 4;
      const endY = branchY - 4;
      svg += `<path class="flow-branch-line" d="M${pubsubCx},${startY} C${pubsubCx},${startY + 20} ${bcx},${endY - 20} ${bcx},${endY}"/>`;

      // Branch box
      svg += `<g class="flow-step">`;
      svg += `<rect class="flow-step-rect" x="${bx}" y="${branchY}" width="${SW}" height="${SH}" fill="${branch.color}10" stroke="${branch.color}66" stroke-width="1"/>`;
      svg += `<text class="flow-step-label" x="${bcx}" y="${bcy - 6}" style="font-size:10px">${branch.label}</text>`;
      svg += `<text class="flow-step-sub" x="${bcx}" y="${bcy + 9}">${branch.sub}</text>`;
      svg += `</g>`;
    });

    // "async fan-out" label
    svg += `<text class="flow-arrow-label" x="${pubsubCx}" y="${pubsubBottom + 18}" style="font-size:8px;fill:${colors.data}">async fan-out</text>`;

    svg += `</svg>`;
    container.innerHTML = svg;
  })();

  // =============================
  // POS FLOW DIAGRAM
  // =============================
  (function buildPOSFlowDiagram() {
    const container = document.getElementById('flowDiagramPOS');
    if (!container) return;

    const SW = 130, SH = 46, GAP = 36, BRANCHGAP = 56;
    const colors = {
      frontend: '#5b9cf5',
      gateway: '#a78bfa',
      backend: '#e94560',
      functions: '#fb923c',
      data: '#f472b6',
      external: '#fbbf24',
    };

    const mainSteps = [
      { label: 'Staff takes order', sub: 'POS tablet', color: colors.frontend },
      { label: 'merchant-web', sub: 'React POS UI', color: colors.frontend },
      { label: 'common-api', sub: 'REST API', color: colors.gateway },
      { label: 'payment-service', sub: 'terminal / card', color: colors.backend },
      { label: 'pub/sub', sub: 'order + payment event', color: colors.data },
    ];

    const branches = [
      { label: 'kitchen dispatch', sub: 'Cloud Function', color: colors.functions },
      { label: 'receipt printing', sub: 'printer-service', color: colors.functions },
      { label: 'cash-register', sub: 'fiscal receipt', color: colors.backend },
      { label: 'webhooks', sub: 'ERP / POS / accounting', color: colors.external },
      { label: 'bigquery', sub: 'CDC replication', color: colors.data },
    ];

    const mainY = 40;
    const branchStartX = (mainSteps.length - 1) * (SW + GAP);
    const branchY = mainY + SH + BRANCHGAP;
    const totalBranchW = branches.length * SW + (branches.length - 1) * 16;
    const branchStartLeft = branchStartX - totalBranchW / 2 + SW / 2;

    const svgW = Math.max(mainSteps.length * (SW + GAP), branchStartLeft + totalBranchW + 40) + 40;
    const svgH = branchY + SH + 50;

    let svg = `<svg width="${svgW}" height="${svgH}" viewBox="0 0 ${svgW} ${svgH}" xmlns="http://www.w3.org/2000/svg">`;
    svg += `<defs><marker id="flowArrowPOS" viewBox="0 0 10 6" refX="10" refY="3" markerWidth="7" markerHeight="5" orient="auto-start-reverse"><path d="M0,0 L10,3 L0,6" fill="#1a4a7a"/></marker></defs>`;

    const phases = [
      { x: 0 * (SW + GAP) + SW / 2 + 20, label: 'trigger' },
      { x: 1.5 * (SW + GAP) + SW / 2 + 20, label: 'ordering' },
      { x: 3 * (SW + GAP) + SW / 2 + 20, label: 'payment' },
      { x: 4 * (SW + GAP) + SW / 2 + 20, label: 'events' },
    ];
    phases.forEach(p => {
      svg += `<text class="flow-phase-label" x="${p.x}" y="18">${p.label}</text>`;
    });

    mainSteps.forEach((step, i) => {
      const x = 20 + i * (SW + GAP);
      const cx = x + SW / 2;
      const cy = mainY + SH / 2;

      if (i < mainSteps.length - 1) {
        const x1 = x + SW + 4;
        const x2 = x + SW + GAP - 4;
        svg += `<line class="flow-arrow-line" x1="${x1}" y1="${mainY + SH/2}" x2="${x2}" y2="${mainY + SH/2}" marker-end="url(#flowArrowPOS)"/>`;
      }

      svg += `<g class="flow-step">`;
      svg += `<rect class="flow-step-rect" x="${x}" y="${mainY}" width="${SW}" height="${SH}" fill="${step.color}15" stroke="${step.color}" stroke-width="1.2"/>`;
      svg += `<text class="flow-step-label" x="${cx}" y="${cy - 6}">${step.label}</text>`;
      svg += `<text class="flow-step-sub" x="${cx}" y="${cy + 9}">${step.sub}</text>`;
      svg += `</g>`;
    });

    const pubsubCx = 20 + (mainSteps.length - 1) * (SW + GAP) + SW / 2;
    const pubsubBottom = mainY + SH;

    branches.forEach((branch, i) => {
      const bx = branchStartLeft + i * (SW + 16);
      const bcx = bx + SW / 2;
      const bcy = branchY + SH / 2;

      const startY = pubsubBottom + 4;
      const endY = branchY - 4;
      svg += `<path class="flow-branch-line" d="M${pubsubCx},${startY} C${pubsubCx},${startY + 20} ${bcx},${endY - 20} ${bcx},${endY}" marker-end="url(#flowArrowPOS)"/>`;

      svg += `<g class="flow-step">`;
      svg += `<rect class="flow-step-rect" x="${bx}" y="${branchY}" width="${SW}" height="${SH}" fill="${branch.color}10" stroke="${branch.color}66" stroke-width="1"/>`;
      svg += `<text class="flow-step-label" x="${bcx}" y="${bcy - 6}" style="font-size:10px">${branch.label}</text>`;
      svg += `<text class="flow-step-sub" x="${bcx}" y="${bcy + 9}">${branch.sub}</text>`;
      svg += `</g>`;
    });

    svg += `<text class="flow-arrow-label" x="${pubsubCx}" y="${pubsubBottom + 18}" style="font-size:8px;fill:${colors.data}">async fan-out</text>`;

    svg += `</svg>`;
    container.innerHTML = svg;
  })();

  // =============================
  // VIEW TOGGLE (Grid ↔ Graph)
  // =============================
  const viewBtns = document.querySelectorAll('.view-btn');
  const mainEl = document.querySelector('.main');
  const graphContainer = document.getElementById('graphContainer');
  const graphLegend = document.getElementById('graphLegend');
  const graphZoomControls = document.getElementById('graphZoomControls');
  const graphDetail = document.getElementById('graphDetail');
  const infoContainer = document.getElementById('infoContainer');

  let graphInitialized = false;

  viewBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      viewBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const view = btn.dataset.view;

      // Hide all views
      mainEl.style.display = 'none';
      graphContainer.classList.remove('active');
      graphLegend.classList.remove('visible');
      graphZoomControls.classList.remove('visible');
      graphDetail.classList.remove('visible');
      infoContainer.classList.remove('active');

      if (view === 'grid') {
        mainEl.style.display = '';
      } else if (view === 'graph') {
        graphContainer.classList.add('active');
        graphLegend.classList.add('visible');
        graphZoomControls.classList.add('visible');
        if (!graphInitialized) { initGraph(); graphInitialized = true; }
      } else if (view === 'info') {
        infoContainer.classList.add('active');
      }
    });
  });

  // =============================
  // GRAPH DATA & RENDERING
  // =============================
  function initGraph() {
    const svg = document.getElementById('graphSvg');
    const world = document.getElementById('graphWorld');
    const edgesGroup = document.getElementById('edgesGroup');
    const nodesGroup = document.getElementById('nodesGroup');
    const detail = document.getElementById('graphDetail');
    const detailContent = document.getElementById('detailContent');
    const detailClose = document.getElementById('detailClose');

    const W = svg.clientWidth || window.innerWidth;
    const H = svg.clientHeight || (window.innerHeight - 128);

    const layerColors = {
      frontend: '#5b9cf5',
      gateway: '#a78bfa',
      backend: '#e94560',
      functions: '#fb923c',
      data: '#f472b6',
      external: '#fbbf24',
    };

    const layerLabels = {
      frontend: 'Frontend',
      gateway: 'API Layer',
      backend: 'Backend Services',
      functions: 'Cloud Functions',
      data: 'Data Layer',
      external: 'External',
    };

    // Y-band for each layer
    const layerY = {
      frontend: H * 0.08,
      gateway: H * 0.24,
      backend: H * 0.44,
      functions: H * 0.64,
      data: H * 0.80,
      external: H * 0.95,
    };

    // Node definitions
    const nodes = [
      { id: 'storefront-web',  label: 'storefront-web',      sub: 'Next.js / SSR',     layer: 'frontend', desc: 'Consumer-facing ordering app. QR table orders, takeaway, room service, loyalty.' },
      { id: 'merchant-web',    label: 'merchant-web',         sub: 'React / Vite SPA',  layer: 'frontend', desc: 'Merchant backoffice dashboard. POS, inventory management, analytics, team management.' },

      { id: 'merchant-api',    label: 'merchant-api',         sub: 'GraphQL',            layer: 'gateway', desc: 'Primary merchant-facing GraphQL API. Handles all merchant dashboard operations.' },
      { id: 'common-api',      label: 'common-api',           sub: 'Fastify REST',       layer: 'gateway', desc: 'Centralized REST API. API key auth, rate limiting, webhook system. Scalar docs at /docs.' },
      { id: 'graph-api',       label: 'graph-api',            sub: 'GraphQL',            layer: 'gateway', desc: 'Consumer-facing GraphQL API. Aggregates mobile-api, merchant-api, delivery, box, user, giftcard services.' },

      { id: 'payment-service',    label: 'payment-service',      sub: 'Node.js',     layer: 'backend', desc: 'Payment processing hub. Stripe, Adyen, Swish integration. Purchase lifecycle management.' },
      { id: 'storefront-service', label: 'storefront-service',   sub: 'Node.js',     layer: 'backend', desc: 'Core storefront business logic. Tab management, order processing, session handling.' },
      { id: 'internal-api',       label: 'internal-api',         sub: 'Node.js',     layer: 'backend', desc: 'Internal service-to-service API. Private endpoints not exposed externally.' },
      { id: 'inventory-service',  label: 'inventory-service',    sub: 'Node.js',     layer: 'backend', desc: 'Product catalog and inventory management. Stock tracking and availability.' },
      { id: 'payout-service',     label: 'payout-account',       sub: 'Node.js',     layer: 'backend', desc: 'Merchant payout account management and settlement processing.' },
      { id: 'cash-register',      label: 'cash-register',        sub: 'Node.js',     layer: 'backend', desc: 'Cash register and receipt management for physical POS terminals.' },
      { id: 'mail-services',      label: 'communication-service', sub: 'Mail, Slack, SMS', layer: 'backend', desc: 'Mail, Slack, and SMS communication services.' },
      { id: 'pos-dispatcher',     label: 'pos-dispatcher',       sub: 'Node.js',     layer: 'backend', desc: 'Dispatches orders to external POS systems and third-party integrations.' },
      { id: 'printer-service',    label: 'printer-service',      sub: 'Node.js',     layer: 'backend', desc: 'Cloud functions for receipt and kitchen ticket printing.' },

      { id: 'cf-functions',  label: 'cf-* functions',   sub: '10 Pub/Sub functions', layer: 'functions', desc: 'Common Cloud Functions. Webhooks, payment cleanup, loyalty, kitchen dispatch.' },

      { id: 'postgresql', label: 'postgresql',  sub: 'Cloud SQL',       layer: 'data', desc: 'Primary transactional database. Shared karma database with all services via VPC connector.' },
      { id: 'redis',      label: 'redis',       sub: 'Memorystore',     layer: 'data', desc: 'In-memory cache. Rate limiting, session storage, real-time data caching.' },
      { id: 'bigquery',   label: 'bigquery',    sub: 'Data Warehouse',  layer: 'data', desc: 'Historical analytics. CDC replication from PostgreSQL. Routes queries >24h to BigQuery automatically.' },
      { id: 'pubsub',     label: 'pub/sub',     sub: 'Message Queue',   layer: 'data', desc: 'Event-driven messaging. Triggers Cloud Functions, async webhook delivery, PSP event processing.' },

      { id: 'adyen',   label: 'adyen',   sub: 'Payments',    layer: 'external', desc: 'Primary payment processor. Card payments, terminals, payouts.' },
      { id: 'stripe',  label: 'stripe',  sub: 'Payments',    layer: 'external', desc: 'Secondary payment processor. Online payments and subscriptions.' },
      { id: 'swish',   label: 'swish',   sub: 'Mobile Pay',  layer: 'external', desc: 'Swedish mobile payment system for instant P2P and merchant payments.' },
      { id: 'sentry',  label: 'sentry',  sub: 'Monitoring',  layer: 'external', desc: 'Real-time error tracking across all services.' },
    ];

    // Position nodes in layer bands, spread horizontally
    const layerGroups = {};
    nodes.forEach(n => {
      if (!layerGroups[n.layer]) layerGroups[n.layer] = [];
      layerGroups[n.layer].push(n);
    });

    Object.entries(layerGroups).forEach(([layer, group]) => {
      const count = group.length;
      const spacing = Math.min(180, (W - 120) / count);
      const totalW = spacing * (count - 1);
      const startX = (W - totalW) / 2;
      group.forEach((n, i) => {
        n.x = startX + i * spacing;
        n.y = layerY[layer];
        n.fx = n.x;
        n.fy = n.y;
      });
    });

    const nodeMap = {};
    nodes.forEach(n => nodeMap[n.id] = n);

    // Edges
    const edges = [
      // Frontend → API/Services
      { from: 'storefront-web', to: 'storefront-service', type: 'api', label: 'API calls' },
      { from: 'storefront-web', to: 'common-api', type: 'api', label: 'inventory, loyalty, checkout' },
      { from: 'storefront-web', to: 'payment-service', type: 'api', label: 'payment processing' },
      { from: 'storefront-web', to: 'sentry', type: 'monitor', label: 'error reporting' },
      { from: 'merchant-web', to: 'merchant-api', type: 'api', label: 'GraphQL + WebSocket' },
      { from: 'merchant-web', to: 'common-api', type: 'api', label: 'unified order API' },
      { from: 'merchant-web', to: 'internal-api', type: 'api', label: 'media, support, AI' },

      // graph-api → services (aggregator)
      { from: 'graph-api', to: 'merchant-api', type: 'api', label: 'K8s internal' },
      { from: 'graph-api', to: 'redis', type: 'api', label: 'rate limiting' },
      { from: 'graph-api', to: 'pubsub', type: 'event', label: 'events' },

      // common-api → services & data
      { from: 'common-api', to: 'postgresql', type: 'api', label: 'database' },
      { from: 'common-api', to: 'redis', type: 'api', label: 'caching, rate limiting' },
      { from: 'common-api', to: 'bigquery', type: 'api', label: 'analytics queries' },
      { from: 'common-api', to: 'pubsub', type: 'event', label: 'events, webhooks' },
      { from: 'common-api', to: 'payment-service', type: 'api', label: 'payment operations' },
      { from: 'common-api', to: 'payout-service', type: 'api', label: 'payout management' },
      { from: 'common-api', to: 'printer-service', type: 'api', label: 'CloudPRNT' },
      { from: 'common-api', to: 'internal-api', type: 'api', label: 'internal services' },
      { from: 'common-api', to: 'sentry', type: 'monitor', label: 'error reporting' },

      // merchant-api → services & data
      { from: 'merchant-api', to: 'postgresql', type: 'api', label: 'database' },
      { from: 'merchant-api', to: 'pubsub', type: 'event', label: 'events' },
      { from: 'merchant-api', to: 'bigquery', type: 'api', label: 'analytics' },
      { from: 'merchant-api', to: 'payment-service', type: 'api', label: 'payment management' },
      { from: 'merchant-api', to: 'inventory-service', type: 'api', label: 'product management' },
      { from: 'merchant-api', to: 'payout-service', type: 'api', label: 'payout operations' },
      { from: 'merchant-api', to: 'cash-register', type: 'api', label: 'register management' },

      // storefront-service → services & data
      { from: 'storefront-service', to: 'postgresql', type: 'api', label: 'database' },
      { from: 'storefront-service', to: 'redis', type: 'api', label: 'sessions, cache' },
      { from: 'storefront-service', to: 'pubsub', type: 'event', label: 'tab events' },
      { from: 'storefront-service', to: 'payment-service', type: 'api', label: 'payment processing' },
      { from: 'storefront-service', to: 'inventory-service', type: 'api', label: 'products' },
      { from: 'storefront-service', to: 'pos-dispatcher', type: 'api', label: 'POS integration' },

      // payment-service → services & data
      { from: 'payment-service', to: 'postgresql', type: 'api', label: 'database' },
      { from: 'payment-service', to: 'pubsub', type: 'event', label: 'payment events' },
      { from: 'payment-service', to: 'cash-register', type: 'api', label: 'receipt data' },
      { from: 'payment-service', to: 'adyen', type: 'api', label: 'card payments' },
      { from: 'payment-service', to: 'stripe', type: 'api', label: 'online payments' },
      { from: 'payment-service', to: 'swish', type: 'api', label: 'mobile payments' },

      // Other backend → data
      { from: 'inventory-service', to: 'postgresql', type: 'api', label: 'database' },
      { from: 'payout-service', to: 'postgresql', type: 'api', label: 'database' },
      { from: 'cash-register', to: 'postgresql', type: 'api', label: 'database' },
      { from: 'mail-services', to: 'pubsub', type: 'event', label: 'mail, Slack, SMS' },
      { from: 'pos-dispatcher', to: 'pubsub', type: 'event', label: 'order events' },

      // Cloud Functions
      { from: 'pubsub', to: 'cf-functions', type: 'event', label: 'triggers' },
      { from: 'cf-functions', to: 'postgresql', type: 'api', label: 'VPC connector' },
      { from: 'cf-functions', to: 'common-api', type: 'api', label: 'VPC 10.100.0.10' },
    ];

    // Build adjacency for highlight lookups
    const adjacency = {};
    nodes.forEach(n => adjacency[n.id] = { outgoing: [], incoming: [] });
    edges.forEach(e => {
      adjacency[e.from].outgoing.push(e);
      adjacency[e.to].incoming.push(e);
    });

    // Node dimensions
    const NW = 130, NH = 44, NR = 8;

    // ---- Render edges ----
    function edgePath(e) {
      const s = nodeMap[e.from];
      const t = nodeMap[e.to];
      if (!s || !t) return '';
      const sx = s.x, sy = s.y, tx = t.x, ty = t.y;
      const dy = ty - sy;
      const dx = tx - sx;

      // Determine attachment points (bottom of source, top of target if going down; sides otherwise)
      let x1, y1, x2, y2;
      if (Math.abs(dy) > NH) {
        // Vertical connection
        x1 = sx; y1 = sy + NH/2;
        x2 = tx; y2 = ty - NH/2;
      } else {
        // Horizontal-ish
        if (dx > 0) {
          x1 = sx + NW/2; y1 = sy;
          x2 = tx - NW/2; y2 = ty;
        } else {
          x1 = sx - NW/2; y1 = sy;
          x2 = tx + NW/2; y2 = ty;
        }
      }

      // Smooth cubic bezier
      const midY = (y1 + y2) / 2;
      return `M${x1},${y1} C${x1},${midY} ${x2},${midY} ${x2},${y2}`;
    }

    function edgeMidpoint(e) {
      const s = nodeMap[e.from];
      const t = nodeMap[e.to];
      if (!s || !t) return { x: 0, y: 0 };
      return { x: (s.x + t.x) / 2, y: (s.y + t.y) / 2 };
    }

    const markerMap = { api: 'url(#arrowApi)', event: 'url(#arrowEvent)', monitor: 'url(#arrowMonitor)' };

    // Create edge elements
    const edgeEls = [];
    edges.forEach((e, i) => {
      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      g.classList.add('edge-group');

      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.classList.add('graph-edge', `type-${e.type}`);
      path.setAttribute('d', edgePath(e));
      path.setAttribute('marker-end', markerMap[e.type]);
      path.dataset.idx = i;

      // Label background + text
      const mid = edgeMidpoint(e);
      const labelBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      labelBg.classList.add('edge-label-bg');
      const labelText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      labelText.classList.add('edge-label-text');
      labelText.textContent = e.label;
      labelText.setAttribute('x', mid.x);
      labelText.setAttribute('y', mid.y);

      // Measure after append
      g.appendChild(path);
      g.appendChild(labelBg);
      g.appendChild(labelText);
      edgesGroup.appendChild(g);

      // Size the bg rect
      try {
        const bbox = labelText.getBBox();
        labelBg.setAttribute('x', bbox.x - 4);
        labelBg.setAttribute('y', bbox.y - 2);
        labelBg.setAttribute('width', bbox.width + 8);
        labelBg.setAttribute('height', bbox.height + 4);
      } catch(ex) {}

      // Hover on edge shows label
      path.addEventListener('mouseenter', () => {
        labelBg.style.opacity = '1';
        labelText.style.opacity = '1';
        path.classList.add('highlighted');
      });
      path.addEventListener('mouseleave', () => {
        labelBg.style.opacity = '0';
        labelText.style.opacity = '0';
        if (!path.classList.contains('force-highlight')) path.classList.remove('highlighted');
      });

      edgeEls.push({ g, path, labelBg, labelText, data: e, index: i });
    });

    // ---- Render nodes ----
    const nodeEls = [];
    nodes.forEach(n => {
      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      g.classList.add('graph-node');
      g.setAttribute('transform', `translate(${n.x}, ${n.y})`);
      g.dataset.id = n.id;

      const body = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      body.classList.add('node-body');

      const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      rect.classList.add('node-rect');
      rect.setAttribute('x', -NW/2);
      rect.setAttribute('y', -NH/2);
      rect.setAttribute('width', NW);
      rect.setAttribute('height', NH);
      rect.setAttribute('fill', 'var(--bg-card)');
      rect.setAttribute('stroke', layerColors[n.layer]);

      // Glow dot
      const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      dot.classList.add('node-dot');
      dot.setAttribute('cx', -NW/2 + 12);
      dot.setAttribute('cy', 0);
      dot.setAttribute('fill', layerColors[n.layer]);

      const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      label.classList.add('node-label');
      label.setAttribute('x', 4);
      label.setAttribute('y', -5);
      label.textContent = n.label;

      const sublabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      sublabel.classList.add('node-sublabel');
      sublabel.setAttribute('x', 4);
      sublabel.setAttribute('y', 9);
      sublabel.textContent = n.sub;

      // Invisible hit area — outside node-body so scale transform doesn't affect it
      const hitRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      hitRect.setAttribute('x', -NW/2 - 8);
      hitRect.setAttribute('y', -NH/2 - 8);
      hitRect.setAttribute('width', NW + 16);
      hitRect.setAttribute('height', NH + 16);
      hitRect.setAttribute('fill', 'transparent');
      hitRect.setAttribute('rx', '12');

      body.appendChild(rect);
      body.appendChild(dot);
      body.appendChild(label);
      body.appendChild(sublabel);
      g.appendChild(hitRect);
      g.appendChild(body);
      nodesGroup.appendChild(g);

      nodeEls.push({ g, data: n });
    });

    // ---- Interactions: hover highlight ----
    let highlightedNode = null;

    function highlightNode(nodeId) {
      if (highlightedNode === nodeId) return;
      highlightedNode = nodeId;
      const connected = new Set([nodeId]);
      edgeEls.forEach(ee => {
        const isConn = ee.data.from === nodeId || ee.data.to === nodeId;
        if (isConn) {
          connected.add(ee.data.from);
          connected.add(ee.data.to);
          ee.path.classList.add('highlighted', 'force-highlight');
          ee.path.classList.remove('dimmed');
          ee.labelBg.style.opacity = '1';
          ee.labelText.style.opacity = '1';
        } else {
          ee.path.classList.remove('highlighted', 'force-highlight');
          ee.path.classList.add('dimmed');
          ee.labelBg.style.opacity = '0';
          ee.labelText.style.opacity = '0';
        }
      });
      nodeEls.forEach(ne => {
        if (connected.has(ne.data.id)) {
          ne.g.classList.add('highlighted');
          ne.g.classList.remove('dimmed');
        } else {
          ne.g.classList.remove('highlighted');
          ne.g.classList.add('dimmed');
        }
      });
    }

    function clearHighlight() {
      highlightedNode = null;
      edgeEls.forEach(ee => {
        ee.path.classList.remove('highlighted', 'dimmed', 'force-highlight');
        ee.labelBg.style.opacity = '0';
        ee.labelText.style.opacity = '0';
      });
      nodeEls.forEach(ne => {
        ne.g.classList.remove('highlighted', 'dimmed');
      });
    }

    let hoverTimer = null;
    nodeEls.forEach(ne => {
      ne.g.addEventListener('mouseenter', () => {
        if (hoverTimer) { clearTimeout(hoverTimer); hoverTimer = null; }
        if (!dragTarget) highlightNode(ne.data.id);
      });
      ne.g.addEventListener('mouseleave', () => {
        if (hoverTimer) clearTimeout(hoverTimer);
        hoverTimer = setTimeout(() => {
          if (!dragTarget) clearHighlight();
          hoverTimer = null;
        }, 80);
      });
    });

    // ---- Hover detail panel ----
    let detailTimer = null;
    nodeEls.forEach(ne => {
      ne.g.addEventListener('mouseenter', () => {
        if (detailTimer) { clearTimeout(detailTimer); detailTimer = null; }
        showDetail(ne.data);
      });
      ne.g.addEventListener('mouseleave', () => {
        if (detailTimer) clearTimeout(detailTimer);
        detailTimer = setTimeout(() => {
          detail.classList.remove('visible');
          detailTimer = null;
        }, 200);
      });
    });

    // Keep panel open when hovering the panel itself
    detail.addEventListener('mouseenter', () => {
      if (detailTimer) { clearTimeout(detailTimer); detailTimer = null; }
    });
    detail.addEventListener('mouseleave', () => {
      if (detailTimer) clearTimeout(detailTimer);
      detailTimer = setTimeout(() => {
        detail.classList.remove('visible');
        detailTimer = null;
      }, 200);
    });

    detailClose.addEventListener('click', () => {
      detail.classList.remove('visible');
    });

    function showDetail(n) {
      const out = adjacency[n.id].outgoing;
      const inc = adjacency[n.id].incoming;
      const color = layerColors[n.layer];
      let html = `
        <div class="detail-name" style="color:${color}">${n.label}</div>
        <div class="detail-tech">${n.sub}</div>
        <div class="detail-layer-badge" style="background:${color}18;color:${color};border:1px solid ${color}33">${layerLabels[n.layer]}</div>
        ${n.desc ? `<div style="font-size:12px;color:var(--text-muted);line-height:1.5;margin-bottom:14px">${n.desc}</div>` : ''}
      `;
      if (out.length) {
        html += `<div class="detail-section-title">Outgoing (${out.length})</div><ul class="detail-conn-list">`;
        out.forEach(e => {
          const targetNode = nodeMap[e.to];
          html += `<li class="detail-conn-item">
            <span class="detail-conn-arrow" style="color:${color}">&rarr;</span>
            <span style="color:var(--text)">${targetNode ? targetNode.label : e.to}</span>
            <span class="detail-conn-type ${e.type}">${e.type}</span>
            <span style="color:var(--text-dim);font-size:10px;margin-left:auto">${e.label}</span>
          </li>`;
        });
        html += '</ul>';
      }
      if (inc.length) {
        html += `<div class="detail-section-title">Incoming (${inc.length})</div><ul class="detail-conn-list">`;
        inc.forEach(e => {
          const srcNode = nodeMap[e.from];
          html += `<li class="detail-conn-item">
            <span class="detail-conn-arrow" style="color:${layerColors[srcNode?.layer] || '#888'}">&larr;</span>
            <span style="color:var(--text)">${srcNode ? srcNode.label : e.from}</span>
            <span class="detail-conn-type ${e.type}">${e.type}</span>
            <span style="color:var(--text-dim);font-size:10px;margin-left:auto">${e.label}</span>
          </li>`;
        });
        html += '</ul>';
      }
      if (!out.length && !inc.length) {
        html += '<div style="color:var(--text-dim);font-size:12px;margin-top:8px">No connections mapped</div>';
      }
      detailContent.innerHTML = html;
      detail.classList.add('visible');
    }

    // ---- Drag nodes ----
    let dragTarget = null;
    let dragOffset = { x: 0, y: 0 };

    function getPointerSVG(ev) {
      const pt = svg.createSVGPoint();
      pt.x = ev.clientX;
      pt.y = ev.clientY;
      const ctm = world.getScreenCTM().inverse();
      return pt.matrixTransform(ctm);
    }

    nodeEls.forEach(ne => {
      ne.g.addEventListener('mousedown', (ev) => {
        if (ev.button !== 0) return;
        ev.stopPropagation();
        dragTarget = ne;
        const p = getPointerSVG(ev);
        dragOffset.x = ne.data.x - p.x;
        dragOffset.y = ne.data.y - p.y;
        svg.classList.add('dragging-node');
      });
    });

    svg.addEventListener('mousemove', (ev) => {
      if (!dragTarget) return;
      const p = getPointerSVG(ev);
      const n = dragTarget.data;
      n.x = p.x + dragOffset.x;
      n.y = p.y + dragOffset.y;
      n.fx = n.x;
      n.fy = n.y;
      dragTarget.g.setAttribute('transform', `translate(${n.x},${n.y})`);
      updateEdges();
    });

    svg.addEventListener('mouseup', () => {
      if (dragTarget) {
        svg.classList.remove('dragging-node');
        dragTarget = null;
      }
    });

    function updateEdges() {
      edgeEls.forEach(ee => {
        ee.path.setAttribute('d', edgePath(ee.data));
        const mid = edgeMidpoint(ee.data);
        ee.labelText.setAttribute('x', mid.x);
        ee.labelText.setAttribute('y', mid.y);
        try {
          const bbox = ee.labelText.getBBox();
          ee.labelBg.setAttribute('x', bbox.x - 4);
          ee.labelBg.setAttribute('y', bbox.y - 2);
          ee.labelBg.setAttribute('width', bbox.width + 8);
          ee.labelBg.setAttribute('height', bbox.height + 4);
        } catch(ex) {}
      });
    }

    // ---- Pan & Zoom ----
    let zoom = 1;
    let panX = 0, panY = 0;
    let isPanning = false;
    let panStart = { x: 0, y: 0 };

    function applyTransform() {
      world.setAttribute('transform', `translate(${panX},${panY}) scale(${zoom})`);
    }

    svg.addEventListener('wheel', (ev) => {
      ev.preventDefault();
      const dir = ev.deltaY < 0 ? 1.08 : 1/1.08;
      const newZoom = Math.max(0.2, Math.min(3, zoom * dir));

      // Zoom toward cursor
      const rect = svg.getBoundingClientRect();
      const mx = ev.clientX - rect.left;
      const my = ev.clientY - rect.top;
      panX = mx - (mx - panX) * (newZoom / zoom);
      panY = my - (my - panY) * (newZoom / zoom);
      zoom = newZoom;
      applyTransform();
    }, { passive: false });

    svg.addEventListener('mousedown', (ev) => {
      if (ev.button !== 0 || dragTarget) return;
      isPanning = true;
      panStart.x = ev.clientX - panX;
      panStart.y = ev.clientY - panY;
      svg.classList.add('panning');
    });

    window.addEventListener('mousemove', (ev) => {
      if (!isPanning) return;
      panX = ev.clientX - panStart.x;
      panY = ev.clientY - panStart.y;
      applyTransform();
    });

    window.addEventListener('mouseup', () => {
      if (isPanning) {
        isPanning = false;
        svg.classList.remove('panning');
      }
    });

    // Zoom buttons
    document.getElementById('zoomIn').addEventListener('click', () => {
      zoom = Math.min(3, zoom * 1.25);
      applyTransform();
    });
    document.getElementById('zoomOut').addEventListener('click', () => {
      zoom = Math.max(0.2, zoom / 1.25);
      applyTransform();
    });
    document.getElementById('zoomReset').addEventListener('click', () => {
      zoom = 1; panX = 0; panY = 0;
      applyTransform();
    });

    // Initial centering — nudge a bit to center the graph nicely
    panX = W * 0.05;
    panY = 10;
    applyTransform();
  }
</script>
</body>
</html>
